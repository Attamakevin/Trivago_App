<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="{{ url_for('static', filename='images/ico.png') }}" type="image/x-icon">
        <title>Reservation Center - trivago</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/translate.css') }}">
        <!-- TailwindCSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet">
        <!-- Custom Script -->
        <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>
        <script defer src="{{ url_for('static', filename='js/translate.js') }}"></script>
        <script defer src="{{ url_for('static', filename='js/user.js') }}"></script>
    </head>

    <body class="min-h-screen">
        <!-- Header -->
        <header class="sticky h-16 top-0 z-50 bg-[#2563eb] shadow-sm py-2 md:py-4 px-4 md:px-8">
            <div class="flex items-center justify-start gap-8 text-white h-full">
                <button onclick="history.back()" class="text-white hover:text-blue-200 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-white text-sm md:text-md font-bold">Hotel Reservation Center</h1>
            </div>
        </header>

        <div class="px-4 py-6 space-y-8 bg-cover bg-center"
            style="background-image: url('{{ url_for('static', filename='images/hotel1.jpg') }}')">
            <!-- Reservation Stats Section -->
            <div class="flex flex-col sm:flex-row items-center sm:justify-between p-6">
                <div class="mb-6 bg-white rounded-lg shadow-sm p-4 text ">
                    <div class="text-sm md:text-sm font-bold text-purple-600 mb-2">
                        {{ reservations|length if reservations else 0 }}
                    </div>
                    <p class="text-xs text-gray-700 font-medium">Total Reservations Made</p>
                    <p class="text-xs text-gray-500">VIP Level: <span class="text-lg text-purple-600">{{ user.vip_level }} </span></p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="openRulesModal()"
                        class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center">
                        <i class="fas fa-book mr-2"></i>
                        Rules & Guidelines
                    </button>
                    <button onclick="openOrderHistoryModal()"
                        class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center">
                        <i class="fas fa-list-ul mr-2"></i>
                        Order History
                    </button>
                </div>
            </div>

            <!-- Dancing Hotel Logos Section -->
            <div class="p-6 bg-[#101f56] text-[#f7b437] rounded-lg shadow-sm overflow-hidden">
                <h3 class="text-xl font-bold text-center mb-6">Our Hotel Partners</h3>
                <div class="flex flex-wrap justify-center items-center gap-8 md:gap-12">
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-red-100 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-hotel text-red-600 text-2xl md:text-3xl"></i>
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-blue-100 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-building text-blue-600 text-2xl md:text-3xl"></i>
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-green-100 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-bed text-green-600 text-2xl md:text-3xl"></i>
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-purple-100 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-home text-purple-600 text-2xl md:text-3xl"></i>
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-yellow-100 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-star text-yellow-600 text-2xl md:text-3xl"></i>
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-pink-100 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-crown text-pink-600 text-2xl md:text-3xl"></i>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <p class="text-sm">500+ Premium Hotel Partners Worldwide</p>
                </div>
            </div>

            <!-- Main Action Card -->
            <div class="overflow-hidden bg-[#101f56]">
                <!-- Reservation Button -->
                <div class="p-8 text-center">
                    <button onclick="openReservationModal()"
                        class="bg-[#f7b437] hover:bg-[#f7b437] font-bold py-4 px-8 rounded-xl transition-colors text-sm text-white shadow-lg">
                        Make Reservation
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Trial Bonus -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-40 rounded-full flex items-center justify-center">
                                    <i class="fas fa-gift text-xl"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">${{ "%.2f"|format(user_stats.trial_bonus) }}
                            </div>
                            <p class="text-sm text-[#101f56]">Trial Bonus</p>
                            <p class="text-xs text-[#101f56] mt-1">Expires in 15 days</p>
                        </div>

                        <!-- Account Balance -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-wallet text-xl text-teal-600"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">${{ "%.2f"|format(user.balance) }}</div>
                            <p class="text-[#101f56] text-sm">Account Balance</p>
                            <p class="text-xs text-[#101f56] mt-1">Available for withdrawal</p>
                        </div>

                        <!-- Earned Commission -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-xl text-orange-600"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">${{
                                "%.2f"|format(user_stats.total_commission) }}</div>
                            <p class="text-[#101f56] text-sm">Earned Commission</p>
                            <p class="text-xs text-[#101f56] mt-1">Total earnings</p>
                        </div>

                        <!-- Hotel Booking Deposit -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-piggy-bank text-xl text-purple-600"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">${{ "%.2f"|format(user_stats.deposit_balance)
                                }}</div>
                            <p class="text-[#101f56] text-sm">Booking Deposits</p>
                            <p class="text-xs text-[#101f56] mt-1">{{ user_stats.active_bookings }} active bookings</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

       <!-- Hotel Selection Modal -->
<div id="reservationModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden overflow-scroll">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md slide-up max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Select Hotel for Reservation</h3>
                    <button onclick="closeReservationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-6 px-6 py-6">
                    {% if current_hotel_data %}
                    <div class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <div class="relative">
                            <img src="{{ url_for('static', filename='images/hotel1.jpg') }}"
                                alt="{{ current_hotel_data.hotel.name }}" class="w-full h-48 object-cover">
                            <div class="absolute top-3 right-3 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                Available
                            </div>
                            <!-- Commission Badge -->
                            <div class="absolute top-3 left-3 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                ${{ "%.2f"|format(current_hotel_data.commission) }} Commission
                            </div>
                        </div>
                        <div class="p-4">
                            <h4 class="font-bold text-lg text-gray-900 mb-2">{{ current_hotel_data.hotel.name }}</h4>
                            <p class="text-gray-600 text-sm mb-3">{{ current_hotel_data.hotel.location }}</p>
                            
                            <!-- Assignment Info -->
                            {% if current_hotel_data.assigned_at %}
                            <div class="text-xs text-gray-500 mb-2">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                Assigned: {{ current_hotel_data.assigned_at.strftime('%B %d, %Y') }}
                            </div>
                            {% endif %}
                            
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <!-- Clickable Star Rating Display -->
                                    <div class="flex items-center">
                                        {% for i in range(5) %}
                                        <button type="button"
                                            class="hotel-star-btn text-sm transition-colors duration-200 {% if i < current_hotel_data.hotel.rating|round|int %}text-yellow-400{% else %}text-gray-300{% endif %}"
                                            data-hotel-id="{{ current_hotel_data.hotel.id }}" data-rating="{{ i + 1 }}"
                                            onclick="rateHotel({{ current_hotel_data.hotel.id }}, {{ i + 1 }})">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        {% endfor %}
                                        <span class="ml-2 text-sm text-gray-600">({{ "%.1f"|format(current_hotel_data.hotel.rating) }})</span>
                                    </div>
                                </div>
                                <span class="text-lg font-bold text-green-600">${{ "%.2f"|format(current_hotel_data.hotel.price) }}</span>
                            </div>
                            
                            <!-- Commission Details -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-blue-800">
                                        <i class="fas fa-dollar-sign mr-1"></i>
                                        Your Commission
                                    </span>
                                    <span class="text-lg font-bold text-blue-600">
                                        ${{ "%.2f"|format(current_hotel_data.commission) }}
                                         x {{ "%.2f"|format(current_hotel_data.hotel.commission_multiplier or 1.0) }}
                                    </span>

                                </div>
     
                                <p class="text-xs text-blue-600 mt-1">
                                    
                                    Earn this amount when you complete your reservation and rating
                                </p>
                            </div>
                            
                            <form method="POST" action="{{ url_for('reserve', hotel_id=current_hotel_data.hotel.id) }}" class="w-full">
                                <button type="button"
                                    onclick="openPreReservationModal({{ current_hotel_data.hotel.id }}, '{{ current_hotel_data.hotel.name }}', {{ current_hotel_data.commission }})"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-calendar-plus mr-2"></i>Reserve Now
                                </button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <!-- Show when using legacy hotels list (fallback) -->
                    {% for hotel in hotels %}
                    <div class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <div class="relative">
                            <img src="{{ url_for('static', filename='images/hotel' + loop.index|string + '.jpg') }}"
                                alt="{{ hotel.name }}" class="w-full h-48 object-cover">
                            <div class="absolute top-3 right-3 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                Available
                            </div>
                            <!-- Commission Badge from mapping -->
                            {% if hotel_commission_map and hotel.id in hotel_commission_map %}
                            <div class="absolute top-3 left-3 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                ${{ "%.2f"|format(hotel_commission_map[hotel.id]) }} Commission
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <h4 class="font-bold text-lg text-gray-900 mb-2">{{ hotel.name }}</h4>
                            <p class="text-gray-600 text-sm mb-3">{{ hotel.location }}</p>
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <!-- Clickable Star Rating Display -->
                                    <div class="flex items-center">
                                        {% for i in range(5) %}
                                        <button type="button"
                                            class="hotel-star-btn text-sm transition-colors duration-200 {% if i < hotel.rating|round|int %}text-yellow-400{% else %}text-gray-300{% endif %}"
                                            data-hotel-id="{{ hotel.id }}" data-rating="{{ i + 1 }}"
                                            onclick="rateHotel({{ hotel.id }}, {{ i + 1 }})">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        {% endfor %}
                                        <span class="ml-2 text-sm text-gray-600">({{ "%.1f"|format(hotel.rating) }})</span>
                                    </div>
                                </div>
                                <span class="text-lg font-bold text-green-600">${{ "%.2f"|format(hotel.price) }}</span>
                            </div>
                            
                            <!-- Commission Details -->
                            {% if hotel_commission_map and hotel.id in hotel_commission_map %}
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-blue-800">
                                        <i class="fas fa-dollar-sign mr-1"></i>
                                        Your Commission
                                    </span>
                                    <span class="text-lg font-bold text-blue-600">
                                        ${{ "%.2f"|format(hotel_commission_map[hotel.id]) }}
                                    </span>
                                </div>
                                <p class="text-xs text-blue-600 mt-1">
                                    x {{ "%.2f"|format(hotel.commission_multiplier or 1.0) }}
                                    Earn this amount when you complete your reservation and rating
                                </p>
                            </div>
                            {% endif %}
                            
                            <form method="POST" action="{{ url_for('reserve', hotel_id=hotel.id) }}" class="w-full">
                                <button type="button"
                                    onclick="openPreReservationModal({{ hotel.id }}, '{{ hotel.name }}', {{ hotel_commission_map[hotel.id] if hotel_commission_map and hotel.id in hotel_commission_map else 0 }})"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    <i class="fas fa-calendar-plus mr-2"></i>Reserve Now
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                {% if not current_hotel_data and not hotels %}
                <div class="text-center py-12">
                    <i class="fas fa-check-circle text-green-400 text-6xl mb-4"></i>
                    <h4 class="text-xl font-semibold text-gray-600 mb-2">All Hotels Completed!</h4>
                    <p class="text-gray-500 mb-4">Congratulations! You've completed all your assigned hotels, Contact Customer service for more hotel tasks.</p>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mx-4">
                        <div class="flex items-center justify-center">
                            <i class="fas fa-trophy text-green-500 mr-2"></i>
                            <span class="text-green-700 font-medium">
                                Total Earned: ${{ "%.2f"|format(user_stats.total_commission) }}
                            </span>
                        </div>
                        
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Pre-Reservation Survey Modal -->
<div id="preReservationModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md slide-up">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Tell us more about your stay</h3>
                    <button onclick="closePreReservationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <h4 id="preReservationHotelName" class="text-lg font-semibold text-gray-800 mb-2"></h4>
                    
                    <!-- Commission Display in Modal -->
                    <div id="preReservationCommission" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        
                    <p class="text-sm text-gray-600 mb-4">Please answer these quick questions before completing your reservation:</p>

                    <!-- Survey Questions -->
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="serviceQuality"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="serviceQuality" class="ml-3 text-sm text-gray-700">Are you satisfied
                                with our service quality?</label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="roomCleanliness"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="roomCleanliness" class="ml-3 text-sm text-gray-700">Was the room clean
                                as expected?</label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="staffFriendliness"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="staffFriendliness" class="ml-3 text-sm text-gray-700">Did the staff
                                provide great services?</label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="overallSatisfaction"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="overallSatisfaction" class="ml-3 text-sm text-gray-700">Was the food
                                great?</label>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="recommendService"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="recommendService" class="ml-3 text-sm text-gray-700">Would you recommend
                                our service to others?</label>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3">
                    <button onclick="closePreReservationModal()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 text-sm font-medium py-3 px-4 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button id="submitPreReservationBtn" onclick="submitPreReservation()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-3 px-4 rounded-lg transition-colors">
                        Complete Reservation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Order History Modal -->
        <div id="orderHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="bg-white rounded-2xl shadow-xl w-full max-w-5xl slide-up max-h-[80vh] min-h-[80vh] overflow-auto">
                    <div class="p-6">
                        <div class="p-4 sticky z-50 top-0 bg-white">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-900">Order History</h3>
                                <button onclick="closeOrderHistoryModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div class="mb-4">
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="filterOrders('all')"
                                        class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">
                                        All Orders
                                    </button>
                                    <button onclick="filterOrders('processing')"
                                        class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">
                                        Processing
                                    </button>
                                    <button onclick="filterOrders('completed')"
                                        class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                                        Completed
                                    </button>
                                    <button onclick="filterOrders('cancelled')"
                                        class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                                        Cancelled
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="ordersList" class="space-y-4">
                            {% if reservations %}
                            {% for reservation in reservations %}
                            <!-- CHANGE: Added data-reservation-id attribute -->
                            <div class="order-item bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow"
                                data-status="{{ reservation.status }}" data-reservation-id="{{ reservation.id }}">
                                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <h4 class="font-semibold text-lg text-gray-900">{{ reservation.hotel_name }}
                                            </h4>
                                            <span
                                                class="status-badge px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                {{ reservation.status|title }}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-600 space-y-1">
                                            <!-- <p><i class="fas fa-map-marker-alt mr-2"></i>{{ reservation.location }}</p> -->
                                            <p><i
                                                    class="fas fa-calendar mr-2"></i>{{ reservation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                            </p>
                                            <p><i class="fas fa-dollar-sign mr-2"></i>Price: ${{
                                                "%.2f"|format(reservation.price) }}</p>
                                            <p><i class="fas fa-coins mr-2"></i>Commission Earned: ${{
                                                "%.2f"|format(reservation.commission) }}</p>
                                            <!-- CHANGE: Show commission payment status -->
                                            {% if reservation.commission_paid %}
                                            <p class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Commission
                                                Paid</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 min-w-[120px]">
                                        <!-- CHANGE: Updated button text and logic -->
                                        {% if reservation.status == 'completed' and not reservation.rated %}
                                        <button onclick=""
                                            class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium py-2 px-3 rounded-lg transition-colors">
                                            <i class="fas fa-star mr-1"></i>Rate Experience
                                        </button>
                                        {% elif reservation.rated %}
                                        <span class="text-green-600 text-xs font-medium text-center">
                                            <i class="fas fa-check-circle mr-1"></i>Rated
                                        </span>
                                        {% endif %}
                                        <span class="text-xs text-gray-500 text-center">Order #{{ reservation.id
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="text-center py-12">
                                <i class="fas fa-history text-gray-300 text-6xl mb-4"></i>
                                <h4 class="text-xl font-semibold text-gray-600 mb-2">No Order History</h4>
                                <p class="text-gray-500">You haven't made any reservations yet. Start by making your
                                    first reservation!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHANGE: Added Rating Modal -->
        <div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md slide-up">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Rate Your Experience</h3>
                            <button onclick="closeRatingModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="text-center mb-6">
                            <h4 id="ratingHotelName" class="text-lg font-semibold text-gray-800 mb-4"></h4>

                            <!-- Star Rating -->
                            <div class="flex justify-center mb-4">
                                <div class="flex space-x-1" id="starRating">
                                    <button type="button"
                                        class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                        data-rating="1">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <button type="button"
                                        class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                        data-rating="2">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <button type="button"
                                        class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                        data-rating="3">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <button type="button"
                                        class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                        data-rating="4">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    <button type="button"
                                        class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                        data-rating="5">
                                        <i class="fas fa-star"></i>
                                    </button>
                                </div>
                            </div>

                            <p class="text-sm text-gray-600 mb-4" id="ratingText">Click stars to rate</p>
                        </div>

                        <!-- Feedback -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Feedback (Optional)</label>
                            <textarea id="ratingFeedback"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                rows="3" placeholder="Tell us about your experience..."></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex gap-3">
                            <button onclick="closeRatingModal()"
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button id="submitRatingBtn" onclick="submitRating()"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
                                disabled>
                                Submit Rating
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rules Modal -->
        <div id="rulesModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl slide-up max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-900">Rules & Guidelines</h3>
                            <button onclick="closeRulesModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-blue-50 rounded-xl p-4">
                                <h1 class="font-bold mb-2">Current level: {{ user.vip_level }}</h1>
                                <h4 class="font-semibold text-blue-900 mb-2"><i
                                        class="fas fa-check-circle mr-2"></i>Task Description:</h4>
                                <ul class="text-sm text-red-800 space-y-1">
                                    <li>● Only one mobile phone number can be registered for one account. In order to prevent misoperation or a series of
                                    illegal acts, let the platform set corresponding preset rules. The system will automatically match orders when the agent
                                    member makes a reservation. After completing the reservation every day, the amount can be withdrawn to the preset or
                                    escrow bank account. Platform recharge only involves the account owner to transfer money. Other people or anonymous
                                    transfers will affect the security of the account.</li>
                                    <li>● Each account must complete all reservations every day; otherwise it will affect the credit score.</li>
                                    <li>● All reservations are randomly assigned by the system and need to be modified, canceled or skipped after receiving the
                                    reservation.</li>
                                    <li>● Each order is provided by a different trader, so the profit is naturally different. Therefore, before each deposit, you
                                    must get the deposit address from the customer service to complete the Luxury. You must reconfirm the deposit address
                                    with the customer service.</li>
                                    <li>● If there is still no deposit after 30 minutes, you need to reconfirm your deposit address with the customer service.
                                    Avoid unnecessary problems in ongoing transactions.</li>
                                    <li>● If the transfer is to the wrong or overdue verification deposit address, the platform does not assume responsibility.</li>
                                    <li>● Once the account information is associated with a single account, it cannot be changed unless the account cannot
                                    receive withdrawals.</li>
                                    <li class="mt-8"><strong>Note:</strong> Please do not use the same person's information to repeatedly register an account on this platform to avoid data
                                    errors.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-60 hidden">

            <div class="flex items-center justify-center min-h-screen p-4">
                <button onclick="closeSuccessModal()"
                    class="text-gray-400 hover:text-gray-600 flex items-end justify-end">
                    <i class="fas fa-times text-xl"></i></button>
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-green-600 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Reservation Successful!</h3>
                    <!-- CHANGE: Updated success message -->
                    <p class="text-gray-600 mb-6">Your hotel reservation has been completed and commission has been
                        added to your balance!</p>
                    <button onclick="closeSuccessModal()"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        <i class="fas fa-thumbs-up mr-2"></i>Great!
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-60 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Reservation Failed</h3>
                    <p id="errorMessage" class="text-gray-600 mb-6">An error occurred while processing your reservation.
                    </p>
                    <button onclick="closeErrorModal()"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            </div>
        </div>

        <!-- CHANGE: Complete JavaScript Section - This is where all the changes are -->
        <script>
            // UPDATED: Complete JavaScript to match your backend
            let currentReservationId = null;
            let currentHotelName = null;
            let selectedRating = 0;
            let currentHotelId = null; // For pre-reservation modal

            // ========== MODAL FUNCTIONS ==========

            // Hotel Selection Modal
            function openReservationModal() {
                document.getElementById('reservationModal').classList.remove('hidden');
            }

            function closeReservationModal() {
                document.getElementById('reservationModal').classList.add('hidden');
            }

            // ========== PRE-RESERVATION SURVEY MODAL ==========
            function openPreReservationModal(hotelId, hotelName) {
                console.log('Opening pre-reservation modal for hotel:', hotelId, hotelName);
                currentHotelId = hotelId;
                document.getElementById('preReservationHotelName').textContent = hotelName;

                // Reset all checkboxes
                document.querySelectorAll('#preReservationModal input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Show the modal
                document.getElementById('preReservationModal').classList.remove('hidden');
            }

            function closePreReservationModal() {
                console.log('Closing pre-reservation modal');
                document.getElementById('preReservationModal').classList.add('hidden');
                currentHotelId = null;
            }

            function submitPreReservation() {
                const submitBtn = document.getElementById('submitPreReservationBtn');
                const originalText = submitBtn.textContent;

                // Get checkbox responses
                const responses = {
                    serviceQuality: document.getElementById('serviceQuality').checked,
                    roomCleanliness: document.getElementById('roomCleanliness').checked,
                    staffFriendliness: document.getElementById('staffFriendliness').checked,
                    overallSatisfaction: document.getElementById('overallSatisfaction').checked,
                    recommendService: document.getElementById('recommendService').checked
                };

                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';

                // Make the actual reservation
                const formData = new FormData();
                // Add survey responses to form data if needed
                Object.keys(responses).forEach(key => {
                    formData.append(key, responses[key]);
                });

                fetch(`/reserve/${currentHotelId}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            closePreReservationModal();
                            closeReservationModal(); // Close hotel selection modal too
                            document.getElementById('successModal').classList.remove('hidden');
                        } else {
                            showNotification(data.error || 'Failed to create reservation', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('An unexpected error occurred', 'error');
                    })
                    .finally(() => {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    });
            }

            // Hotel Star Rating Function
            function rateHotel(hotelId, rating) {
                // console.log(`Rating hotel ${hotelId} with ${rating} stars`);

                // Update the visual display for this hotel
                const hotelStars = document.querySelectorAll(`[data-hotel-id="${hotelId}"]`);
                hotelStars.forEach((star, index) => {
                    const starRating = parseInt(star.dataset.rating);
                    if (starRating <= rating) {
                        star.classList.add('text-yellow-400');
                        star.classList.remove('text-gray-300');
                    } else {
                        star.classList.remove('text-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });

                // You can add an API call here to save the hotel rating
                showNotification(`Rated hotel with ${rating} stars!`, 'success');
            }

            function openRulesModal() {
                document.getElementById('rulesModal').classList.remove('hidden');
            }

            function closeRulesModal() {
                document.getElementById('rulesModal').classList.add('hidden');
            }

            function openOrderHistoryModal() {
                document.getElementById('orderHistoryModal').classList.remove('hidden');
            }

            function closeOrderHistoryModal() {
                document.getElementById('orderHistoryModal').classList.add('hidden');
            }

            function closeSuccessModal() {
                document.getElementById('successModal').classList.add('hidden');
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }

            function closeErrorModal() {
                document.getElementById('errorModal').classList.add('hidden');
            }

            // CHANGE: Updated rating function to match your backend
            function rateReservation(reservationId) {
                console.log('Rating reservation:', reservationId);
                currentReservationId = reservationId;
                selectedRating = 0;

                // Get hotel name from the DOM
                const orderItem = document.querySelector(`[data-reservation-id="${reservationId}"]`);
                if (orderItem) {
                    currentHotelName = orderItem.querySelector('h4').textContent.trim();
                } else {
                    currentHotelName = 'Hotel';
                }

                // Reset star rating
                document.querySelectorAll('.star-btn').forEach(btn => {
                    btn.classList.remove('text-yellow-400');
                    btn.classList.add('text-gray-300');
                });

                // Reset form
                document.getElementById('ratingFeedback').value = '';
                document.getElementById('ratingText').textContent = 'Click stars to rate';
                document.getElementById('submitRatingBtn').disabled = true;

                // Set hotel name and show modal
                document.getElementById('ratingHotelName').textContent = currentHotelName;
                document.getElementById('ratingModal').classList.remove('hidden');
            }

            function closeRatingModal() {
                document.getElementById('ratingModal').classList.add('hidden');
                currentReservationId = null;
                currentHotelName = null;
                selectedRating = 0;
            }

            // CHANGE: Updated to use your backend endpoint
            function submitRating() {
                if (!selectedRating || selectedRating < 1 || selectedRating > 5) {
                    showNotification('Please select a rating', 'warning');
                    return;
                }

                const feedback = document.getElementById('ratingFeedback').value;
                const submitBtn = document.getElementById('submitRatingBtn');

                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                // CHANGE: Using your backend's endpoint format
                fetch(`/rate/${currentReservationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rating: selectedRating,
                        feedback: feedback
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            closeRatingModal();
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showNotification(data.error || 'Failed to submit rating', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Network error:', error);
                        showNotification('Network error. Please try again.', 'error');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Rating';
                    });
            }

            // Order filtering functions
            function filterOrders(status) {
                const orderItems = document.querySelectorAll('.order-item');
                const filterBtns = document.querySelectorAll('.filter-btn');

                filterBtns.forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });

                const clickedBtn = event.target;
                clickedBtn.classList.add('active', 'bg-blue-600', 'text-white');
                clickedBtn.classList.remove('bg-gray-200', 'text-gray-700');

                orderItems.forEach(item => {
                    const itemStatus = item.dataset.status.toLowerCase();
                    if (status === 'all' || itemStatus === status.toLowerCase()) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            function cancelReservation(reservationId) {
                if (confirm('Are you sure you want to cancel this reservation?')) {
                    showNotification('Reservation cancellation requested', 'info');
                }
            }

            // Star rating functionality for reservation rating modal
            function updateStarDisplay() {
                document.querySelectorAll('.star-btn').forEach((btn, index) => {
                    if (index < selectedRating) {
                        btn.classList.add('text-yellow-400');
                        btn.classList.remove('text-gray-300');
                    } else {
                        btn.classList.remove('text-yellow-400');
                        btn.classList.add('text-gray-300');
                    }
                });
            }

            function highlightStars(rating) {
                document.querySelectorAll('.star-btn').forEach((btn, index) => {
                    if (index < rating) {
                        btn.classList.add('text-yellow-400');
                        btn.classList.remove('text-gray-300');
                    } else {
                        btn.classList.remove('text-yellow-400');
                        btn.classList.add('text-gray-300');
                    }
                });
            }

            function updateRatingText() {
                const ratingTexts = {
                    1: 'Poor - 1 star',
                    2: 'Fair - 2 stars',
                    3: 'Good - 3 stars',
                    4: 'Very Good - 4 stars',
                    5: 'Excellent - 5 stars'
                };
                document.getElementById('ratingText').textContent = ratingTexts[selectedRating] || 'Click stars to rate';
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                        type === 'warning' ? 'bg-yellow-500 text-black' :
                            'bg-blue-500 text-white'
                    }`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function () {
                // Star rating click handlers for reservation rating modal
                document.querySelectorAll('.star-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        selectedRating = parseInt(this.dataset.rating);
                        updateStarDisplay();
                        updateRatingText();
                        document.getElementById('submitRatingBtn').disabled = false;
                    });

                    btn.addEventListener('mouseenter', function () {
                        const hoverRating = parseInt(this.dataset.rating);
                        highlightStars(hoverRating);
                    });
                });

                const starRating = document.getElementById('starRating');
                if (starRating) {
                    starRating.addEventListener('mouseleave', function () {
                        updateStarDisplay();
                    });
                }

                // Hotel star hover effects
                document.querySelectorAll('.hotel-star-btn').forEach(btn => {
                    btn.addEventListener('mouseenter', function () {
                        const hotelId = this.dataset.hotelId;
                        const hoverRating = parseInt(this.dataset.rating);

                        const hotelStars = document.querySelectorAll(`[data-hotel-id="${hotelId}"]`);
                        hotelStars.forEach((star, index) => {
                            const starRating = parseInt(star.dataset.rating);
                            if (starRating <= hoverRating) {
                                star.classList.add('text-yellow-400');
                                star.classList.remove('text-gray-300');
                            } else {
                                star.classList.remove('text-yellow-400');
                                star.classList.add('text-gray-300');
                            }
                        });
                    });

                    btn.addEventListener('mouseleave', function () {
                        const hotelId = this.dataset.hotelId;
                        // Reset to original rating - you might want to store original rating
                        // For now, we'll just keep the last clicked rating
                    });
                });

                // Close modals when clicking outside
                const modals = document.querySelectorAll('[id$="Modal"]');
                modals.forEach(modal => {
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                        }
                    });
                });

                // Close modals with Escape key
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        modals.forEach(modal => {
                            if (!modal.classList.contains('hidden')) {
                                modal.classList.add('hidden');
                            }
                        });
                    }
                });
            });
        </script>

        <!-- CHANGE: Added script to handle success modal on page load -->
        <script>
            function closeSuccessModal() {
                document.getElementById('successModal').classList.add('hidden');
                window.location.href = "/reservations"; // Redirect to reservations page
            }
        </script>
    </body>

</html>