<!-- templates/admin_user_details.html -->
{% extends "admin_base.html" %}

{% block title %}User Details - {{ user.nickname }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">User Details - {{ user.contact }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin_settings') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Users
        </a>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row">
    <!-- User Information -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">User Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Username:</strong> {{ user.nickname }}</p>
                        <p><strong>contact:</strong> {{ user.user_id }}</p>
                        <p><strong>Full Name:</strong> {{ user.full_name or 'Not provided' }}</p>
                        <p><strong>Phone:</strong> {{ user.contact or 'Not provided' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Balance:</strong> ${{ "%.2f"|format(user.balance) }}</p>
                        <p><strong>VIP Level:</strong> 
                            <span class="badge bg-{{ 'primary' if user.vip_level == 'vip3' else ('info' if user.vip_level == 'vip2' else ('warning' if user.vip_level == 'vip1' else 'secondary')) }}">
                                {{ user.vip_level.upper() if user.vip_level else 'VIP0' }}
                            </span>
                        </p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                        </p>
                        <p><strong>Created:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}</p>
                        <p><strong>Last Login:</strong> {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Adjustment -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Balance Adjustment</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}" class="mt-3">

                    <input type="hidden" name="action" value="adjust_balance"/>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adjustment_type" class="form-label">Adjustment Type</label>
                                <select class="form-select" id="adjustment_type" name="adjustment_type" required>
                                    <option value="">Select Type</option>
                                    <option value="add">Add to Balance</option>
                                    <option value="subtract">Subtract from Balance</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount</label>
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason (Optional)</label>
                        <textarea class="form-control" id="reason" name="reason" rows="2" 
                                  placeholder="Enter reason for balance adjustment"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-warning" onclick="return confirm('Are you sure you want to adjust this user\'s balance?')">
                        Adjust Balance
                    </button>
                </form>
            </div>
        </div>

        <!-- VIP Level Management -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">VIP Level Management</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vip_level" class="form-label">Current VIP Level: 
                                    <span class="badge bg-{{ 'primary' if user.vip_level == 'vip3' else ('info' if user.vip_level == 'vip2' else ('warning' if user.vip_level == 'vip1' else 'secondary')) }}">
                                        {{ user.vip_level.upper() if user.vip_level else 'VIP0' }}
                                    </span>
                                </label>
                                <select class="form-select" id="vip_level" name="vip_level" required>
                                    <option value="">Select New VIP Level</option>
                                    {% for level in ['vip0', 'vip1', 'vip2', 'vip3'] %}
                                    <option value="{{ level }}" {{ 'selected' if user.vip_level == level else '' }}>
                                        {{ level.upper() }} 
                                        {% if level == 'vip0' %}(Basic)
                                        {% elif level == 'vip1' %}(Bronze)
                                        {% elif level == 'vip2' %}(Silver)
                                        {% elif level == 'vip3' %}(Gold)
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary" onclick="return confirm('Are you sure you want to update this user\'s VIP level?')">
                                    <i class="fas fa-crown"></i> Update VIP Level
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>VIP Level Benefits:</strong><br>
                                <i class="fas fa-circle text-secondary"></i> VIP0 (Basic): Standard benefits<br>
                                <i class="fas fa-circle text-warning"></i> VIP1 (Bronze): 5% bonus on deposits<br>
                                <i class="fas fa-circle text-info"></i> VIP2 (Silver): 10% bonus + priority support<br>
                                <i class="fas fa-circle text-primary"></i> VIP3 (Gold): 15% bonus + exclusive perks
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recent Bookings -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Bookings</h5>
            </div>
            <div class="card-body">
                {% if user.bookings %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Hotel</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Status</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in user.bookings[:5] %}
                            <tr>
                                <td>{{ booking.id }}</td>
                                <td>{{ booking.hotel.name if booking.hotel else 'N/A' }}</td>
                                <td>{{ booking.check_in_date.strftime('%Y-%m-%d') if booking.check_in_date else 'N/A' }}</td>
                                <td>{{ booking.check_out_date.strftime('%Y-%m-%d') if booking.check_out_date else 'N/A' }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if booking.status == 'confirmed' else ('warning' if booking.status == 'pending' else 'danger') }}">
                                        {{ booking.status.title() if booking.status else 'N/A' }}
                                    </span>
                                </td>
                                <td>${{ "%.2f"|format(booking.total_amount) if booking.total_amount else '0.00' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No bookings found for this user.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions Panel -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <!-- Quick VIP Level Update -->
                <div class="mb-3">
                    <label class="form-label">Quick VIP Update</label>
                    <div class="btn-group d-grid gap-2" role="group">
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}" style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip0">
                            <button type="submit" class="btn btn-outline-secondary btn-sm {{ 'active' if user.vip_level == 'vip0' else '' }}" 
                                    onclick="return confirm('Set VIP level to VIP0?')">VIP0</button>
                        </form>
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}" style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip1">
                            <button type="submit" class="btn btn-outline-warning btn-sm {{ 'active' if user.vip_level == 'vip1' else '' }}" 
                                    onclick="return confirm('Set VIP level to VIP1?')">VIP1</button>
                        </form>
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}" style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip2">
                            <button type="submit" class="btn btn-outline-info btn-sm {{ 'active' if user.vip_level == 'vip2' else '' }}" 
                                    onclick="return confirm('Set VIP level to VIP2?')">VIP2</button>
                        </form>
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}" style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip3">
                            <button type="submit" class="btn btn-outline-primary btn-sm {{ 'active' if user.vip_level == 'vip3' else '' }}" 
                                    onclick="return confirm('Set VIP level to VIP3?')">VIP3</button>
                        </form>
                    </div>
                </div>

                <hr>

                <!-- Toggle User Status -->
                <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}" class="mb-3">
                    
                    <input type="hidden" name="action" value="toggle_status"/>
                    <button type="submit" class="btn btn-{{ 'danger' if user.is_active else 'success' }} w-100" 
                            onclick="return confirm('Are you sure you want to {{ 'deactivate' if user.is_active else 'activate' }} this user?')">
                        {{ 'Deactivate User' if user.is_active else 'Activate User' }}
                    </button>
                </form>

                <!-- Send Message -->
                <button type="button" class="btn btn-info w-100 mb-3" data-bs-toggle="modal" data-bs-target="#messageModal">
                    Send Message
                </button>

                <!-- Reset Password -->
                <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}" class="mb-3">
                
                    <input type="hidden" name="action" value="reset_password"/>
                    <button type="submit" class="btn btn-warning w-100" 
                            onclick="return confirm('Are you sure you want to reset this user\'s password? A new temporary password will be generated.')">
                        Reset Password
                    </button>
                </form>

                <!-- Delete User -->
                {% if not user.bookings or user.bookings|length == 0 %}
                <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}">
                    
                    <button type="submit" class="btn btn-danger w-100" 
                            onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone!')">
                        Delete User
                    </button>
                </form>
                {% else %}
                <button type="button" class="btn btn-danger w-100" disabled title="Cannot delete user with existing bookings">
                    Delete User
                </button>
                <small class="text-muted">Cannot delete users with bookings</small>
                {% endif %}
            </div>
   
<!-- Member Point Update Form -->
<div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-star text-yellow-500 mr-2"></i>
            Update Member Points
        </h3>
        <span class="text-sm text-gray-500">Current: <span id="current-member-points" class="font-semibold">{{ user.member_point or 0 }}</span></span>
    </div>
    
    <form id="memberPointForm" class="space-y-4">
        <input type="hidden" id="userId" value="{{ user.id }}">
        
        <div class="flex items-center space-x-4">
            <div class="flex-1">
                <label for="memberPoint" class="block text-sm font-medium text-gray-700 mb-2">
                    New Member Points
                </label>
                <input type="number" 
                       id="memberPoint" 
                       name="member_point" 
                       value="{{ user.member_point or 0 }}" 
                       min="0" 
                       step="1"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       required>
            </div>
            
            <button type="submit" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200 flex items-center">
                <i class="fas fa-save mr-2"></i>
                Update
            </button>
        </div>
        
        <!-- Quick preset buttons -->
        <div class="flex flex-wrap gap-2">
            <span class="text-sm text-gray-600">Quick set:</span>
            <button type="button" onclick="setMemberPoint(0)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">0</button>
            <button type="button" onclick="setMemberPoint(100)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">100</button>
            <button type="button" onclick="setMemberPoint(500)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">500</button>
            <button type="button" onclick="setMemberPoint(1000)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">1000</button>
            <button type="button" onclick="setMemberPoint(5000)" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">5000</button>
        </div>
    </form>
    
    <!-- Status messages -->
    <div id="memberPointStatus" class="mt-3 hidden">
        <div id="memberPointSuccess" class="hidden p-3 bg-green-100 border border-green-400 text-green-700 rounded">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage"></span>
        </div>
        <div id="memberPointError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMessage">Failed to update member points</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('memberPointForm');
    const memberPointInput = document.getElementById('memberPoint');
    const currentPointsSpan = document.getElementById('current-member-points');
    const statusDiv = document.getElementById('memberPointStatus');
    const successDiv = document.getElementById('memberPointSuccess');
    const errorDiv = document.getElementById('memberPointError');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = document.getElementById('userId').value;
        const newMemberPoint = parseInt(memberPointInput.value);
        const submitButton = form.querySelector('button[type="submit"]');
        
        // Disable submit button during request
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
        
        // Hide previous status messages
        statusDiv.classList.add('hidden');
        successDiv.classList.add('hidden');
        errorDiv.classList.add('hidden');
        
        // Make API request
        fetch(`/admin/api/users/${userId}/member_point`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                member_point: newMemberPoint
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update current points display
                currentPointsSpan.textContent = data.new_member_point;
                
                // Show success message
                successMessage.textContent = data.message;
                successDiv.classList.remove('hidden');
                statusDiv.classList.remove('hidden');
                
                // Auto-hide success message after 3 seconds
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                    successDiv.classList.add('hidden');
                }, 3000);
            } else {
                throw new Error(data.message || 'Update failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorMessage.textContent = error.message || 'Failed to update member points';
            errorDiv.classList.remove('hidden');
            statusDiv.classList.remove('hidden');
        })
        .finally(() => {
            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update';
        });
    });
});

// Function for quick preset buttons
function setMemberPoint(value) {
    document.getElementById('memberPoint').value = value;
}
</script>
     </div>
    <!-- Admin Create Luxury Order Form -->
<div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-gem text-purple-600 mr-3"></i>
            Create Luxury Order
        </h2>
        <p class="text-gray-600 mt-2">Create a special reward order for a user that they can claim for instant credit.</p>
    </div>

    <form id="luxuryOrderForm" class="space-y-6">
        <!-- User Selection -->
        <div>
            <label for="userId" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-user mr-1"></i>
                Select User *
            </label>
            <select id="userId" name="user_id" required 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                <option value="">Choose a user...</option>
        
                <option value="{{ user.id }}">{{ user.contact }} </option>
               
            </select>
        </div>

        <!-- Order Title -->
        <div>
            <label for="orderTitle" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-tag mr-1"></i>
                Order Title *
            </label>
            <input type="text" id="orderTitle" name="title" required maxlength="255"
                   placeholder="e.g., VIP Bonus Reward, Special Achievement Prize"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
        </div>

        <!-- Description -->
        <div>
            <label for="orderDescription" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-align-left mr-1"></i>
                Description
            </label>
            <textarea id="orderDescription" name="description" rows="3"
                      placeholder="Optional description of the luxury order..."
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
        </div>

        <!-- Amount -->
        <div>
            <label for="orderAmount" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-dollar-sign mr-1"></i>
                Credit Amount * ($)
            </label>
            <input type="number" id="orderAmount" name="amount" required min="0.01" step="0.01"
                   placeholder="e.g., 100.00"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
            <p class="text-xs text-gray-500 mt-1">Amount that will be credited to user's account when claimed</p>
        </div>

        <!-- Image URL -->
        <div>
            <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-image mr-1"></i>
                Image URL
            </label>
            <input type="url" id="imageUrl" name="image_url"
                   placeholder="https://example.com/luxury-image.jpg"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
            <p class="text-xs text-gray-500 mt-1">Optional image to display in the luxury order popup</p>
        </div>

        <!-- Expiration -->
        <div>
            <label for="expiresIn" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-clock mr-1"></i>
                Expires In (Hours)
            </label>
            <select id="expiresIn" name="expires_in_hours"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                <option value="">Never expires</option>
                <option value="1">1 hour</option>
                <option value="6">6 hours</option>
                <option value="12">12 hours</option>
                <option value="24">24 hours</option>
                <option value="48">48 hours</option>
                <option value="72">72 hours</option>
                <option value="168">1 week</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Leave empty for no expiration</p>
        </div>

        <!-- Quick Amount Buttons -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Quick Amount Selection:</label>
            <div class="flex flex-wrap gap-2">
                <button type="button" onclick="setAmount(10)" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">$10</button>
                <button type="button" onclick="setAmount(25)" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">$25</button>
                <button type="button" onclick="setAmount(50)" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">$50</button>
                <button type="button" onclick="setAmount(100)" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">$100</button>
                <button type="button" onclick="setAmount(250)" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">$250</button>
                <button type="button" onclick="setAmount(500)" class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">$500</button>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
            <button type="button" onclick="previewOrder()" 
                    class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                <i class="fas fa-eye mr-2"></i>
                Preview
            </button>
            
            <button type="submit" 
                    class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                <i class="fas fa-gem mr-2"></i>
                Create Luxury Order
            </button>
        </div>
    </form>

    <!-- Status Messages -->
    <div id="orderStatus" class="mt-4 hidden">
        <div id="orderSuccess" class="hidden p-4 bg-green-100 border border-green-400 text-green-700 rounded">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successMessage"></span>
        </div>
        <div id="orderError" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorMessage"></span>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Preview Luxury Order</h3>
                    <button onclick="closePreview()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="previewContent" class="text-center">
                    <!-- Preview content will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('luxuryOrderForm');
    const statusDiv = document.getElementById('orderStatus');
    const successDiv = document.getElementById('orderSuccess');
    const errorDiv = document.getElementById('orderError');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
        
        // Hide previous messages
        hideMessages();
        
        fetch('/admin/luxury_orders/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                successMessage.textContent = data.message;
                successDiv.classList.remove('hidden');
                statusDiv.classList.remove('hidden');
                form.reset();
                
                setTimeout(() => hideMessages(), 5000);
            } else {
                throw new Error(data.error || 'Creation failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorMessage.textContent = error.message;
            errorDiv.classList.remove('hidden');
            statusDiv.classList.remove('hidden');
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-gem mr-2"></i>Create Luxury Order';
        });
    });
});

function setAmount(amount) {
    document.getElementById('orderAmount').value = amount;
}

function hideMessages() {
    document.getElementById('orderStatus').classList.add('hidden');
    document.getElementById('orderSuccess').classList.add('hidden');
    document.getElementById('orderError').classList.add('hidden');
}

function previewOrder() {
    const userId = document.getElementById('userId');
    const title = document.getElementById('orderTitle').value;
    const description = document.getElementById('orderDescription').value;
    const amount = document.getElementById('orderAmount').value;
    const imageUrl = document.getElementById('imageUrl').value;
    
    if (!userId.value || !title || !amount) {
        alert('Please fill in required fields (User, Title, Amount) to preview');
        return;
    }
    
    const selectedUser = userId.options[userId.selectedIndex].text;
    
    const previewContent = `
        <div class="luxury-order-preview">
            ${imageUrl ? `<img src="${imageUrl}" alt="Luxury Order" class="w-20 h-20 mx-auto mb-4 rounded-lg object-cover">` : '<div class="w-20 h-20 mx-auto mb-4 bg-purple-100 rounded-lg flex items-center justify-center"><i class="fas fa-gem text-purple-500 text-2xl"></i></div>'}
            <h4 class="text-xl font-bold text-gray-900 mb-2">${title}</h4>
            ${description ? `<p class="text-gray-600 mb-4">${description}</p>` : ''}
            <div class="bg-green-100 border border-green-300 rounded-lg p-3 mb-4">
                <div class="text-2xl font-bold text-green-600">$${parseFloat(amount).toFixed(2)}</div>
                <div class="text-sm text-green-700">Will be credited to account</div>
            </div>
            <p class="text-sm text-gray-500">For: ${selectedUser}</p>
        </div>
    `;
    
    document.getElementById('previewContent').innerHTML = previewContent;
    document.getElementById('previewModal').classList.remove('hidden');
}

function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
}
</script>
        <!-- User Statistics -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ user.bookings|length if user.bookings else 0 }}</h4>
                        <p class="text-muted mb-0">Total Bookings</p>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">${{ "%.2f"|format(user.deposits.map(attribute='amount')|sum if user.deposits else 0) }}</h4>
                        <p class="text-muted mb-0">Total Deposits</p>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <p class="mb-1"><strong>VIP Level:</strong></p>
                    <h3 class="text-{{ 'primary' if user.vip_level == 'vip3' else ('info' if user.vip_level == 'vip2' else ('warning' if user.vip_level == 'vip1' else 'secondary')) }}">
                        <i class="fas fa-crown"></i> {{ user.vip_level.upper() if user.vip_level else 'VIP0' }}
                    </h3>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}">
                
                <input type="hidden" name="action" value="send_message"/>
                
                <div class="modal-header">
                    <h5 class="modal-title">Send Message to {{ user.nickname }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="message_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="message_subject" name="message_subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="message_content" class="form-label">Message</label>
                        <textarea class="form-control" id="message_content" name="message_content" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}