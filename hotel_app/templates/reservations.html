<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="{{ url_for('static', filename='images/ico.png') }}" type="image/x-icon">
        <title>Reservation Center - trivago</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/translate.css') }}">
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet">
        <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>
        <script defer src="{{ url_for('static', filename='js/translate.js') }}"></script>
        <script defer src="{{ url_for('static', filename='js/user.js') }}"></script>

        <style>
            body {
                font-family: 'Montserrat', sans-serif;
            }

            /* Golden Egg Styles */
            .golden-egg-item {
                position: relative;
                width: 120px;
                height: 150px;
                cursor: pointer;
                transition: transform 0.3s;
            }

            .golden-egg-item:hover {
                transform: translateY(-10px);
            }

            .egg-container {
                position: relative;
                width: 100%;
                height: 100%;
            }

            .egg-whole {
                position: absolute;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #ffd700, #ffed4e, #daa520);
                border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
                box-shadow: inset -10px -10px 20px rgba(0, 0, 0, 0.2),
                    inset 10px 10px 20px rgba(255, 255, 255, 0.5),
                    0 10px 30px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                transition: opacity 0.5s;
            }

            .egg-whole::before {
                content: '';
                position: absolute;
                top: 20%;
                left: 20%;
                width: 30%;
                height: 40%;
                background: rgba(255, 255, 255, 0.4);
                border-radius: 50%;
                transform: rotate(25deg);
            }

            .egg-whole::after {
                content: '';
                position: absolute;
                top: 15%;
                right: 25%;
                width: 15%;
                height: 15%;
                background: rgba(255, 255, 255, 0.6);
                border-radius: 50%;
            }

            .egg-top,
            .egg-bottom {
                position: absolute;
                width: 100%;
                opacity: 0;
                transition: all 0.5s;
            }

            .egg-top {
                height: 55%;
                top: 0;
                background: linear-gradient(135deg, #ffd700, #ffed4e, #daa520);
                border-radius: 50% 50% 40% 40% / 60% 60% 30% 30%;
                box-shadow: inset -5px -5px 10px rgba(0, 0, 0, 0.2);
                transform-origin: center bottom;
            }

            .egg-bottom {
                height: 55%;
                bottom: 0;
                background: linear-gradient(135deg, #daa520, #ffd700, #ffed4e);
                border-radius: 40% 40% 50% 50% / 30% 30% 60% 60%;
                box-shadow: inset -5px 5px 10px rgba(0, 0, 0, 0.2);
                transform-origin: center top;
            }

            .egg-cracking .egg-whole {
                animation: shake 0.5s;
                opacity: 0;
                transition-delay: 0.4s;
            }

            .egg-cracking .egg-top {
                opacity: 1;
                transform: rotate(-25deg) translateY(-20px);
                transition-delay: 0.5s;
            }

            .egg-cracking .egg-bottom {
                opacity: 1;
                transform: rotate(15deg) translateY(20px);
                transition-delay: 0.5s;
            }

            @keyframes shake {

                0%,
                100% {
                    transform: translateX(0);
                }

                25% {
                    transform: translateX(-5px) rotate(-2deg);
                }

                75% {
                    transform: translateX(5px) rotate(2deg);
                }
            }

            .sparkle {
                position: absolute;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }

            .sparkle::before,
            .sparkle::after {
                content: '✨';
                position: absolute;
                font-size: 20px;
                animation: sparkleFloat 2s infinite;
            }

            .sparkle::before {
                top: 30%;
                left: 20%;
                animation-delay: 0s;
            }

            .sparkle::after {
                top: 50%;
                right: 20%;
                animation-delay: 1s;
            }

            @keyframes sparkleFloat {
                0% {
                    transform: translateY(0) scale(0);
                    opacity: 0;
                }

                50% {
                    transform: translateY(-20px) scale(1);
                    opacity: 1;
                }

                100% {
                    transform: translateY(-40px) scale(0);
                    opacity: 0;
                }
            }

            .egg-badge {
                position: absolute;
                top: -10px;
                right: -10px;
                background: #ff5722;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
                z-index: 10;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            /* Luxury gradient animations */
            .luxury-gradient {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .luxury-shimmer {
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                animation: shimmer 3s infinite;
            }

            @keyframes shimmer {
                0% {
                    transform: translateX(-100%);
                }

                100% {
                    transform: translateX(100%);
                }
            }

            .luxury-popup-slide-in {
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .slide-up {
                animation: slideUp 0.3s ease-out;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .modal {
                backdrop-filter: blur(4px);
            }

            .hotel-logo {
                animation: float 3s ease-in-out infinite;
            }

            .hotel-logo:nth-child(2) {
                animation-delay: 0.5s;
            }

            .hotel-logo:nth-child(3) {
                animation-delay: 1s;
            }

            .hotel-logo:nth-child(4) {
                animation-delay: 1.5s;
            }

            .hotel-logo:nth-child(5) {
                animation-delay: 2s;
            }

            .hotel-logo:nth-child(6) {
                animation-delay: 2.5s;
            }

            @keyframes float {

                0%,
                100% {
                    transform: translateY(0);
                }

                50% {
                    transform: translateY(-10px);
                }
            }

            .card-hover {
                transition: transform 0.3s ease;
            }

            .card-hover:hover {
                transform: translateY(-5px);
            }

            .partner-logo {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            /* Partner showcase: single-row marquee with elevated animations */
            .partners-showcase {
                position: relative;
                overflow: hidden;
                padding: 0.5rem 0;
                -webkit-mask-image: linear-gradient(to right, transparent, #000 12%, #000 88%, transparent);
                        mask-image: linear-gradient(to right, transparent, #000 12%, #000 88%, transparent);
            }

            .partners-track {
                display: flex;
                gap: 1.5rem;
                align-items: center;
                animation: partnersMarquee 18s linear infinite;
            }

            .partners-track:hover {
                animation-play-state: paused;
            }

            .partner-card {
                position: relative;
                flex: 0 0 auto;
                width: 5rem;
                height: 5rem;
                border-radius: 0.9rem;
                background: linear-gradient(145deg, #f8fafc, #e2e8f0);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                border: 1px solid rgba(255, 255, 255, 0.7);
            }

            .partner-card::after {
                content: '';
                position: absolute;
                inset: 0;
                background: linear-gradient(120deg, transparent 15%, rgba(255, 255, 255, 0.65) 50%, transparent 85%);
                transform: translateX(-140%);
                animation: cardShine 2.6s ease-in-out infinite;
                animation-delay: var(--shine-delay, 0s);
            }

            .partner-card img {
                width: 80%;
                height: 80%;
                object-fit: contain;
                transition: transform 0.8s ease, filter 0.8s ease;
                animation: floatTilt 4.2s ease-in-out infinite;
                animation-delay: var(--tilt-delay, 0s);
            }

            .partner-card:hover img {
                transform: scale(1.1) rotate(-2deg);
                filter: drop-shadow(0 10px 16px rgba(0, 0, 0, 0.18));
            }

            @keyframes partnersMarquee {
                0% { transform: translateX(0); }
                100% { transform: translateX(-50%); }
            }

            @keyframes cardShine {
                0% { transform: translateX(-140%); opacity: 0; }
                15% { opacity: 1; }
                45% { transform: translateX(140%); opacity: 1; }
                60% { opacity: 0.6; }
                100% { opacity: 0; }
            }

            @keyframes floatTilt {
                0%, 100% { transform: translateY(0) rotate(0deg); }
                35% { transform: translateY(-6px) rotate(-2deg); }
                70% { transform: translateY(4px) rotate(2deg); }
            }
        </style>
    </head>

    <body class="max-w-screen-sm mx-auto w-full min-h-screen">
        <!-- Header -->
        <header class="sticky h-16 top-0 z-50 bg-[#2563eb] shadow-sm py-2 px-4">
            <div class="flex items-center justify-start gap-8 text-white h-full">
                <button onclick="history.back()" class="text-white hover:text-blue-200 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 data-translate class="text-white text-sm font-bold">Hotel Reservation Center</h1>
            </div>
        </header>

        <div class="px-4 py-5 space-y-8 bg-cover bg-center"
            style="background-image: url('{{ url_for('static', filename='images/hotel-5.jpg') }}')">
            <!-- Reservation Stats Section -->
            <div class="flex flex-row items-center justify-between px-6 py-3">
                <div class="mb-6 bg-white rounded-lg shadow-sm p-4 text">
                    <div class="text-sm font-bold text-purple-600 mb-2">

                    </div>
                    <p class="text-xs text-gray-600">
                        {% set first_count = user.first_session_reservations_count or 0 %}
                        {% set second_count = user.second_session_reservations_count or 0 %}

                        {% if first_count < 35 %} {{ ((first_count - 1) % 35) + 1 }} {% else %} {{ second_count }} {%
                            endif %} <span data-translate>Reservations for this session</span>
                    </p>

                    <p class="text-xs text-gray-500 mt-2">VIP Level: <span
                            class="text-lg text-purple-600">{{ user.vip_level }}</span></p>
                </div>

                <div class="flex flex-col gap-4 justify-center">
                    <button data-translate onclick="openRulesModal()"
                        class="flex-1 flex-none bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center">
                        <i class="fas fa-book mr-2"></i>Rules & Guidelines
                    </button>
                    <button data-translate onclick="openOrderHistoryModal()"
                        class="flex-1 flex-none bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center">
                        <i class="fas fa-list-ul mr-2"></i>Order History
                    </button>
                </div>
            </div>

            <!-- Dancing Hotel Logos Section -->
            <div class="px-6 py-3 bg-[#101f56] text-[#f7b437] rounded-lg shadow-sm overflow-hidden">
                <h3 data-translate class="text-xl font-bold text-center mb-4">Our Hotel Partners</h3>
                <div class="partners-showcase">
                    <div class="partners-track">
                        <div class="partner-card" style="--shine-delay:0s; --tilt-delay:0s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/626.png" alt="Booking.com" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:0.4s; --tilt-delay:0.2s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/3340.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:0.8s; --tilt-delay:0.4s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/395.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:1.2s; --tilt-delay:0.6s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/2564.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:1.6s; --tilt-delay:0.8s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/634.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:2.0s; --tilt-delay:1.0s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/14.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <!-- Duplicate set for seamless marquee loop -->
                        <div class="partner-card" style="--shine-delay:2.4s; --tilt-delay:1.2s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/626.png" alt="Booking.com" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:2.8s; --tilt-delay:1.4s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/3340.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:3.2s; --tilt-delay:1.6s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/395.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:3.6s; --tilt-delay:1.8s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/2564.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:4.0s; --tilt-delay:2.0s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/634.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                        <div class="partner-card" style="--shine-delay:4.4s; --tilt-delay:2.2s;">
                            <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/14.png" alt="Partner" loading="lazy" class="partner-logo">
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <p data-translate class="text-sm">500+ Premium Hotel Partners Worldwide</p>
                </div>
            </div>

            <!-- Main Action Card -->
            <div class="overflow-hidden bg-[#101f56]">
                <!-- Reservation Button -->
                <div class="px-8 py-8 text-center">
                    <button data-translate onclick="openReservationModal()"
                        class="bg-[#f7b437] hover:bg-[#f7b437] font-bold py-4 px-8 rounded-xl transition-colors text-sm text-white shadow-lg">
                        Make Reservation
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="px-6 py-3">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Trial Bonus Card -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-40 rounded-full flex items-center justify-center">
                                    <i class="fas fa-gift text-xl"></i>
                                </div>
                            </div>
                            <div class="text-xl font-bold mb-1">{{user.currency}}<span id="trialBonusCardDisplay">0.00</span></div>
                            <p data-translate class="text-sm text-[#101f56]">Trial Bonus</p>
                        </div>

                        <!-- Account Balance -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-wallet text-xl text-teal-600"></i>
                                </div>
                            </div>
                            <div class="text-xl font-bold mb-1" id="accountBalanceDisplay">{{user.currency}}0.00</div>
                            <p data-translate class="text-[#101f56] text-sm">Account Balance</p>
                            <p data-translate class="text-xs text-[#101f56] mt-1">Available for withdrawal</p>
                        </div>

                        <!-- Earned Commission -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-xl text-orange-600"></i>
                                </div>
                            </div>
                            <div class="text-xl font-bold mb-1" id="totalCommissionDisplay">{{user.currency}}0.00</div>
                            <p data-translate class="text-[#101f56] text-sm">Earned Commission</p>
                            <p data-translate class="text-xs text-[#101f56] mt-1">Total earnings</p>
                        </div>

                        <!-- Hotel Booking Deposit -->
                        <div id="freezingAmountCard" class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white hidden">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-piggy-bank text-xl text-purple-600"></i>
                                </div>
                            </div>
                            <div class="text-xl font-bold mb-1" id="freezingAmountDisplaye">{{user.currency}}{{ user.total_deposits }}
                            </div>
                            <p data-translate class="text-[#101f56] text-sm">Freezing Amount</p>

                        </div>
                    </div>
                </div>
            </div>

            <!-- LUXURY ORDER POPUP MODAL -->
            <div id="luxuryOrderModal" class="fixed inset-0 bg-black bg-opacity-70 modal z-[100] hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div
                        class="bg-white rounded-3xl shadow-2xl w-full max-w-md luxury-popup-slide-in relative overflow-hidden">
                        <div class="luxury-gradient p-6 text-white text-center relative overflow-hidden">
                            <div class="luxury-shimmer absolute inset-0"></div>
                            <button onclick="closeLuxuryOrderModal()"
                                class="absolute top-4 right-4 text-white hover:text-yellow-100 z-10">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                            <div class="relative z-10">
                                <div
                                    class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-crown text-yellow-300 text-2xl"></i>
                                </div>
                                <h3 data-translate class="text-2xl font-bold mb-2">Luxury Order Available!</h3>
                                <p data-translate class="text-sm opacity-90">Exclusive opportunity just for you</p>
                            </div>
                        </div>
                        <div class="p-6" id="luxuryOrderContent"></div>
                    </div>
                </div>
            </div>

            <div id="luxurySuccessModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-[110] hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-crown text-yellow-600 text-3xl"></i>
                        </div>
                        <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Luxury Order Claimed!</h3>
                        <p data-translate id="luxurySuccessMessage" class="text-gray-600 mb-6">Your luxury order has
                            been successfully claimed!</p>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <span id="luxuryAmountCredited" class="text-lg font-bold text-green-600">{{user.currency}}0.00</span>
                            <p data-translate class="text-xs text-green-600 mt-1">Added to your account balance</p>
                        </div>
                        <button onclick="closeLuxurySuccessModal()"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                            <i class="fas fa-trophy mr-2"></i>Awesome!
                        </button>
                    </div>
                </div>
            </div>

            <!-- GOLDEN EGGs POPUP MODAL -->
            <div id="goldenEggsModal" class="fixed inset-0 bg-black bg-opacity-70 modal z-[100] hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div
                        class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-3xl shadow-2xl w-full max-w-sm relative overflow-hidden">
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-400 p-4 text-white text-center relative">
                            <button onclick="closeGoldenEggsModal()"
                                class="absolute top-4 right-4 text-white hover:text-yellow-100">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                            <h3 class="text-2xl font-bold mb-1">Golden Eggs Available!</h3>
                            <p class="text-sm opacity-90">Click on an egg to crack it open and reveal your reward!</p>
                        </div>
                        <div class="p-8" id="goldenEggsContainer"></div>
                        <div id="eggRewardDisplay" class="hidden p-6 text-center">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mx-auto max-w-sm">
                                <div
                                    class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-coins text-yellow-600 text-3xl"></i>
                                </div>
                                <h4 id="rewardTitle" class="text-xl font-bold text-gray-900 mb-2"></h4>
                                <p id="rewardDescription" class="text-gray-600 mb-4"></p>
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                    <span id="rewardAmount" class="text-2xl font-bold text-green-600"></span>
                                </div>
                                <button id="claimRewardBtn" onclick="claimGoldenEggReward()"
                                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition-all">
                                    <i class="fas fa-hand-holding-usd mr-2"></i>Claim Reward
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="goldenEggSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-[110] hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-crown text-yellow-600 text-3xl"></i>
                        </div>
                        <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Golden Egg Claimed!</h3>
                        <p data-translate id="goldenEggSuccessMessage" class="text-gray-600 mb-6">Your golden egg has
                            been successfully claimed!</p>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <span id="goldenEggAmountCredited" class="text-lg font-bold text-green-600">{{user.currency}}.00</span>
                            <p data-translate class="text-xs text-green-600 mt-1">Added to your account balance</p>
                        </div>
                        <button onclick="closeGoldenEggSuccessModal()"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                            <i class="fas fa-trophy mr-2"></i>Awesome!
                        </button>
                    </div>
                </div>
            </div>

            <!-- Hotel Selection Modal -->
            <div id="reservationModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden overflow-auto">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg slide-up max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-3">
                                <h3 data-translate class="text-xl font-bold text-gray-900">Select Hotel for Reservation
                                </h3>
                                <button onclick="closeReservationModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 gap-6 px-6 py-3">
                                {% if current_hotel_data %}
                                <div
                                    class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                                    <div class="relative">
                                        <img src="{{ current_hotel_data.hotel.primary_picture }}"
                                            alt="{{ current_hotel_data.hotel.name }}" class="w-full h-48 object-cover">
                                        <div
                                            class="absolute top-3 right-3 bg-green-500 capitalize text-white px-2 py-1 rounded-full text-sm font-medium">
                                            {{ current_hotel_data.hotel.category }}
                                        </div>
                                        <div
                                            class="absolute top-3 left-3 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                            {{user.currency}}{{ "%.2f"|format(current_hotel_data.commission) }} Commission
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <h4 class="font-bold text-lg text-gray-900 mb-2">
                                            {{ current_hotel_data.hotel.name }}</h4>
                                        <div class="flex items-center justify-between mb-3">
                                            <p class="text-gray-600 text-sm mb-3">
                                                {{ current_hotel_data.hotel.location }}</p>
                                            <span class="text-lg font-bold text-green-600">{{user.currency}}{{
                                                "%.2f"|format(current_hotel_data.hotel.price) }}</span>
                                        </div>
                                        {% if current_hotel_data.assigned_at %}
                                        <div class="text-xs text-gray-500 mb-2">
                                            <i class="fas fa-calendar-alt mr-1"></i>
                                            Assigned: {{ current_hotel_data.assigned_at.strftime('%B %d, %Y') }}
                                        </div>
                                        {% endif %}

                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center">
                                                <div class="flex items-center">
                                                    {% for i in range(5) %}
                                                    <button type="button"
                                                        class="hotel-star-btn text-2xl transition-colors duration-200 {% if i < current_hotel_data.hotel.rating|round|int %}text-yellow-400{% else %}text-gray-300{% endif %}"
                                                        data-hotel-id="{{ current_hotel_data.hotel.id }}"
                                                        data-rating="{{ i + 1 }}"
                                                        onclick="rateHotel({{ current_hotel_data.hotel.id }}, {{ i + 1 }})">
                                                        <i class="fas fa-star text-4xl"></i>
                                                    </button>
                                                    {% endfor %}
                                                    <span class="ml-2 text-sm text-gray-600">({{
                                                        "%.1f"|format(current_hotel_data.hotel.rating) }})</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-blue-800">Your Commission</span>
                                                <span class="text-lg font-bold text-blue-600">
                                                    {{user.currency}} {{ "%.2f"|format(current_hotel_data.commission) }}
                                                    x
                                                    {{ "%.2f"|format(current_hotel_data.hotel.commission_multiplier or 1.0) }}
                                                </span>
                                            </div>
                                            <p data-translate class="text-xs text-blue-600 mt-1">Earn this amount when
                                                you complete your reservation and rating</p>
                                        </div>

                                        <form method="POST"
                                            action="{{ url_for('reserve', hotel_id=current_hotel_data.hotel.id) }}"
                                            class="w-full">
                                            <button data-translate type="button"
                                                onclick="openPreReservationModal({{ current_hotel_data.hotel.id }}, '{{ current_hotel_data.hotel.name }}', {{ current_hotel_data.commission }})"
                                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                                <i class="fas fa-calendar-plus mr-2"></i>Reserve Now
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center py-12">
                                    <i class="fas fa-check-circle text-green-400 text-6xl mb-4"></i>
                                    <h4 data-translate class="font-semibold text-2xl text-gray-600 mb-1">Task Completed!
                                    </h4>
                                    <p data-translate class="text-gray-800 text-lg mb-4">Please contact customer service
                                        to reset.</p>
                                    <a href="{{ url_for('customer_service') }}"
                                        class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-4 px-8 rounded-lg transition-colors mt-4">
                                        Confirm
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order History Modal -->
            <div id="orderHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div
                        class="bg-white rounded-2xl shadow-xl w-full max-w-5xl slide-up max-h-[80vh] min-h-[80vh] overflow-auto">
                        <div class="p-6">
                            <div class="p-4 sticky z-50 top-0 bg-white">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 data-translate class="text-xl font-bold text-gray-900">Order History</h3>
                                    <button onclick="closeOrderHistoryModal()"
                                        class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>

                                <div class="mb-4">
                                    <div class="flex flex-wrap gap-2">
                                        <button data-translate onclick="filterOrders('all')"
                                            class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">
                                            All Orders
                                        </button>
                                        <button data-translate onclick="filterOrders('processing')"
                                            class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                                            Processing
                                        </button>
                                        <button data-translate onclick="filterOrders('completed')"
                                            class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                                            Completed
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="ordersList" class="space-y-4">
                                {% if reservations %}
                                {% for reservation in reservations %}
                                <div class="order-item bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow"
                                    data-status="{{ reservation.status }}" data-reservation-id="{{ reservation.id }}">
                                    <div class="flex flex-col flex-row items-center justify-between gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <h4 class="font-semibold text-lg text-gray-900">
                                                    {{ reservation.hotel_name }}</h4>
                                                <span
                                                    class="status-badge px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    {{ reservation.status|title }}
                                                </span>
                                            </div>
                                            <div class="text-sm text-gray-600 space-y-1">
                                                <p><i
                                                        class="fas fa-calendar mr-2"></i>{{ reservation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                                </p>
                                                <p>Price: {{user.currency}}{{ "%.2f"|format(reservation.price) }}</p>
                                                <p><i class="fas fa-coins mr-2"></i>Commission Earned: {{user.currency}}{{
                                                    "%.2f"|format(reservation.commission) }}</p>
                                                {% if reservation.commission_paid %}
                                                <p class="text-green-600"><i
                                                        class="fas fa-check-circle mr-2"></i>Commission Paid</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2 min-w-[120px]">
                                            {% if reservation.status == 'completed' and not reservation.rated %}
                                            <button data-translate onclick="rateReservation({{ reservation.id }})"
                                                class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium py-2 px-3 rounded-lg transition-colors">
                                                <i class="fas fa-star mr-1"></i>Rate Experience
                                            </button>
                                            {% elif reservation.rated %}
                                            <span class="text-green-600 text-xs font-medium text-center">
                                                <i class="fas fa-check-circle mr-1"></i>Rated
                                            </span>
                                            {% endif %}
                                            <span class="text-xs text-gray-500 text-center">Order #{{ reservation.id
                                                }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="text-center py-12">
                                    <i class="fas fa-history text-gray-300 text-6xl mb-4"></i>
                                    <h4 data-translate class="text-xl font-semibold text-gray-600 mb-2">No Order History
                                    </h4>
                                    <p data-translate class="text-gray-500">You haven't made any reservations yet. Start
                                        by making your first reservation!</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pre-Reservation Survey Modal -->
            <div id="preReservationModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md slide-up">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 data-translate class="text-xl font-bold text-gray-900">Tell us more about your stay
                                </h3>
                                <button onclick="closePreReservationModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div class="mb-6">
                                <h4 id="preReservationHotelName" class="text-lg font-semibold text-gray-800 mb-2"></h4>
                                <div id="preReservationCommission"
                                    class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                    <p data-translate class="text-sm text-gray-600 mb-4">Please answer these quick
                                        questions before completing your reservation:</p>
                                    <div class="space-y-4">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="serviceQuality"
                                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <label data-translate for="serviceQuality"
                                                class="ml-3 text-sm text-gray-700">Are you satisfied with our service
                                                quality?</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="roomCleanliness"
                                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <label data-translate for="roomCleanliness"
                                                class="ml-3 text-sm text-gray-700">Was the room clean as
                                                expected?</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="staffFriendliness"
                                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <label data-translate for="staffFriendliness"
                                                class="ml-3 text-sm text-gray-700">Did the staff provide great
                                                services?</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="overallSatisfaction"
                                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <label data-translate for="overallSatisfaction"
                                                class="ml-3 text-sm text-gray-700">Was the food great?</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="recommendService"
                                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                            <label data-translate for="recommendService"
                                                class="ml-3 text-sm text-gray-700">Would you recommend our service to
                                                others?</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <button data-translate onclick="closePreReservationModal()"
                                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 text-sm font-medium py-3 px-4 rounded-lg transition-colors">
                                        Cancel
                                    </button>
                                    <button data-translate id="submitPreReservationBtn" onclick="submitPreReservation()"
                                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-3 px-4 rounded-lg transition-colors opacity-50 cursor-not-allowed"
                                        disabled>
                                        Complete Reservation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rating Modal -->
            <div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md slide-up">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 data-translate class="text-xl font-bold text-gray-900">Rate Your Experience</h3>
                                <button onclick="closeRatingModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div class="text-center mb-6">
                                <h4 id="ratingHotelName" class="text-lg font-semibold text-gray-800 mb-4"></h4>
                                <div class="flex justify-center mb-4">
                                    <div class="flex space-x-1" id="starRating">
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="1">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="2">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="3">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="4">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="5">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                </div>
                                <p data-translate class="text-sm text-gray-600 mb-4" id="ratingText">Click stars to rate
                                </p>
                            </div>

                            <div class="mb-6">
                                <label data-translate class="block text-sm font-medium text-gray-700 mb-2">Feedback
                                    (Optional)</label>
                                <textarea id="ratingFeedback"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    rows="3" placeholder="Tell us about your experience..."></textarea>
                            </div>

                            <div class="flex gap-3">
                                <button data-translate onclick="closeRatingModal()"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-colors">
                                    Cancel
                                </button>
                                <button data-translate id="submitRatingBtn" onclick="submitRating()"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
                                    disabled>
                                    Submit Rating
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rules Modal -->
            <div id="rulesModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl slide-up max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 data-translate class="text-xl font-bold text-gray-900">Rules & Guidelines</h3>
                                <button onclick="closeRulesModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-blue-50 rounded-xl p-4">
                                    <h1 class="font-bold mb-2">Current level: {{ user.vip_level }}</h1>
                                    <h4 data-translate class="font-semibold text-blue-900 mb-2"><i
                                            class="fas fa-check-circle mr-2"></i>Task Description:</h4>
                                    <ul data-translate class="text-sm text-red-800 space-y-1">
                                        <li>• Only one mobile phone number can be registered for one account. In order
                                            to prevent misoperation or a series of illegal acts, let the platform set
                                            corresponding preset rules. The system will automatically match orders when
                                            the agent member makes a reservation. After completing the reservation every
                                            day, the amount can be withdrawn to the preset or escrow bank account.
                                            Platform recharge only involves the account owner to transfer money. Other
                                            people or anonymous transfers will affect the security of the account.</li>
                                        <li>• Each account must complete all reservations every day; otherwise it will
                                            affect the credit score.</li>
                                        <li>• All reservations are randomly assigned by the system and need to be
                                            modified, canceled or skipped after receiving the reservation.</li>
                                        <li>• Each order is provided by a different trader, so the profit is naturally
                                            different. Therefore, before each deposit, you must get the deposit address
                                            from the customer service to complete the Luxury. You must reconfirm the
                                            deposit address with the customer service.</li>
                                        <li>• If there is still no deposit after 30 minutes, you need to reconfirm your
                                            deposit address with the customer service. Avoid unnecessary problems in
                                            ongoing transactions.</li>
                                        <li>• If the transfer is to the wrong or overdue verification deposit address,
                                            the platform does not assume responsibility.</li>
                                        <li>• Once the account information is associated with a single account, it
                                            cannot be changed unless the account cannot receive withdrawals.</li>
                                        <li class="mt-8"><strong>Note:</strong> Please do not use the same person's
                                            information to repeatedly register an account on this platform to avoid data
                                            errors.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Modal -->
            <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-60 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8 relative">
                        <button onclick="closeSuccessModal()"
                            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-check text-green-600 text-3xl"></i>
                        </div>
                        <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Reservation Successful!</h3>
                        <p data-translate class="text-gray-600 mb-6">Your hotel reservation has been completed and
                            commission has been added to your balance!</p>
                        <button data-translate onclick="closeSuccessModal()"
                            class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                            <i class="fas fa-thumbs-up mr-2"></i>Great!
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Modal -->
            <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-60 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
                        </div>
                        <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Reservation Failed</h3>
                        <p data-translate id="errorMessage" class="text-gray-600 mb-6">An error occurred while
                            processing your reservation.</p>
                        <button data-translate onclick="closeErrorModal()"
                            class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                </div>
            </div>

            <script>
                // ========== GLOBAL VARIABLES ==========
                // Safely parse values with fallbacks
                let userBalanceRaw = parseFloat('{{ user.balance }}');
                let trialBonusRaw = parseFloat('{{ user_stats.trial_bonus }}');
                let totalCommissionRaw = parseFloat('{{ user.total_commission_earned}}');
                let reservationCountRaw = parseInt('{{ user.first_session_reservations_count|default(0) }}') || 0;

                let currentUserBalance = isNaN(userBalanceRaw) ? 0 : userBalanceRaw;
                let currentTrialBonus = isNaN(trialBonusRaw) ? 0 : trialBonusRaw;
                let currentTotalCommission = isNaN(totalCommissionRaw) ? 0 : totalCommissionRaw;
                let currentReservationCount = isNaN(reservationCountRaw) ? 0 : reservationCountRaw;

                console.log('Raw values from backend:');
                console.log('Balance raw:', userBalanceRaw, 'Parsed:', currentUserBalance);
                console.log('Trial bonus raw:', trialBonusRaw, 'Parsed:', currentTrialBonus);
                console.log('Total commission raw:', totalCommissionRaw, 'Parsed:', currentTotalCommission);
                console.log('Reservation count raw:', reservationCountRaw, 'Parsed:', currentReservationCount);
                let currentReservationId = null;
                let currentHotelName = null;
                let selectedRating = 0;
                let currentHotelId = null;
                let currentGoldenEgg = null;

                // ========== INITIALIZATION ==========
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('=== PAGE INITIALIZATION START ===');
                    console.log('Parsed balance:', currentUserBalance);
                    console.log('Parsed trial bonus:', currentTrialBonus);
                    console.log('Parsed total commission:', currentTotalCommission);
                    console.log('Parsed reservation count:', currentReservationCount);

                    initializeAllDisplays();
                    initializeStarRating();
                    initializeHotelStarRatings();
                    initializeModalHandlers();
                    checkForFlashMessages();

                    console.log('=== PAGE INITIALIZATION COMPLETE ===');
                });

                // ========== UNIFIED DISPLAY INITIALIZATION ==========
                function initializeAllDisplays() {
                    console.log('Starting initializeAllDisplays()');

                    // Account Balance
                    const accountBalanceDisplay = document.getElementById('accountBalanceDisplay');
                    if (accountBalanceDisplay) {
                        accountBalanceDisplay.textContent = `{{user.currency}}${currentUserBalance.toFixed(2)}`;
                        console.log('Set account balance to:', `{{user.currency}}${currentUserBalance.toFixed(2)}`);
                    }

                    // Trial Bonus (Top Card)
                    const trialBonusDisplay = document.getElementById('trialBonusDisplay');
                    if (trialBonusDisplay) {
                        trialBonusDisplay.textContent = `${currentTrialBonus.toFixed(2)}`;
                        console.log('Set trial bonus (top) to:', `${currentTrialBonus.toFixed(2)}`);
                    }

                    // Trial Bonus (Card Grid)
                    const trialBonusCardDisplay = document.getElementById('trialBonusCardDisplay');
                    if (trialBonusCardDisplay) {
                        trialBonusCardDisplay.textContent = `${currentTrialBonus.toFixed(2)}`;
                        console.log('Set trial bonus (card) to:', `${currentTrialBonus.toFixed(2)}`);
                    }

                    // Reservation Count
                    const reservationCountDisplay = document.getElementById('reservationCountDisplay');
                    if (reservationCountDisplay) {
                        reservationCountDisplay.textContent = currentReservationCount;
                        console.log('Set reservation count to:', currentReservationCount);
                    }

                    // Total Commission
                    const totalCommissionDisplay = document.getElementById('totalCommissionDisplay');
                    if (totalCommissionDisplay) {
                        totalCommissionDisplay.textContent = `{{user.currency}}${currentTotalCommission.toFixed(2)}`;
                        console.log('Set total commission to:', `{{user.currency}}${currentTotalCommission.toFixed(2)}`);
                    }

                    // Check freezing card visibility
                    checkFreezingCardState(currentUserBalance);
                }

                function updateAllBalanceDisplays(newBalance) {
                    currentUserBalance = parseFloat(newBalance);
                    if (isNaN(currentUserBalance)) {
                        currentUserBalance = 0;
                    }

                    console.log('Updating balance displays to:', currentUserBalance);

                    const accountBalanceDisplay = document.getElementById('accountBalanceDisplay');
                    if (accountBalanceDisplay) {
                        accountBalanceDisplay.textContent = `{{user.currency}}${currentUserBalance.toFixed(2)}`;
                    }

                    updateFreezingCardAmount(currentUserBalance);
                    checkFreezingCardState(currentUserBalance);
                }

                function updateFreezingCardAmount(balance) {
                    const freezingAmountDisplay = document.getElementById('freezingAmountDisplay');
                    if (freezingAmountDisplay) {
                        freezingAmountDisplay.textContent = `{{user.currency}}${Math.abs(balance).toFixed(2)}`;
                    }
                }

                function checkFreezingCardState(balance) {
                    const freezingCard = document.getElementById('freezingAmountCard');
                    if (!freezingCard) return;

                    // Always show the card regardless of balance value
                    freezingCard.classList.remove('hidden');
                    freezingCard.style.display = 'block';
                }

                // ========== STAR RATING SYSTEM ==========
                function initializeStarRating() {
                    console.log('Initializing star rating system...');

                    document.querySelectorAll('.star-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            selectedRating = parseInt(this.dataset.rating);
                            updateStarDisplay();
                            updateRatingText();
                            document.getElementById('submitRatingBtn').disabled = false;
                        });

                        btn.addEventListener('mouseenter', function () {
                            const hoverRating = parseInt(this.dataset.rating);
                            highlightStars(hoverRating);
                        });
                    });

                    const starRating = document.getElementById('starRating');
                    if (starRating) {
                        starRating.addEventListener('mouseleave', function () {
                            updateStarDisplay();
                        });
                    }
                }

                function initializeHotelStarRatings() {
                    console.log('Initializing hotel star ratings...');

                    document.querySelectorAll('.hotel-star-btn').forEach(btn => {
                        btn.addEventListener('click', function () {
                            const hotelId = this.dataset.hotelId;
                            const rating = parseInt(this.dataset.rating);
                            rateHotel(hotelId, rating);
                        });
                    });
                }

                function updateStarDisplay() {
                    document.querySelectorAll('.star-btn').forEach((btn, index) => {
                        if (index < selectedRating) {
                            btn.classList.add('text-yellow-400');
                            btn.classList.remove('text-gray-300');
                        } else {
                            btn.classList.remove('text-yellow-400');
                            btn.classList.add('text-gray-300');
                        }
                    });
                }

                function highlightStars(rating) {
                    document.querySelectorAll('.star-btn').forEach((btn, index) => {
                        if (index < rating) {
                            btn.classList.add('text-yellow-400');
                            btn.classList.remove('text-gray-300');
                        } else {
                            btn.classList.remove('text-yellow-400');
                            btn.classList.add('text-gray-300');
                        }
                    });
                }

                function updateRatingText() {
                    const ratingTexts = {
                        1: 'Poor - 1 star',
                        2: 'Fair - 2 stars',
                        3: 'Good - 3 stars',
                        4: 'Very Good - 4 stars',
                        5: 'Excellent - 5 stars'
                    };
                    const ratingTextElement = document.getElementById('ratingText');
                    if (ratingTextElement) {
                        ratingTextElement.textContent = ratingTexts[selectedRating] || 'Click stars to rate';
                    }
                }

                function rateHotel(hotelId, rating) {
                    console.log(`Rating hotel ${hotelId} with ${rating} stars`);

                    const hotelStars = document.querySelectorAll(`[data-hotel-id="${hotelId}"]`);
                    hotelStars.forEach((star, index) => {
                        const starRating = parseInt(star.dataset.rating);
                        if (starRating <= rating) {
                            star.classList.add('text-yellow-400');
                            star.classList.remove('text-gray-300');
                        } else {
                            star.classList.remove('text-yellow-400');
                            star.classList.add('text-gray-300');
                        }
                    });

                    showNotification(`Thanks for your ${rating}-star rating!`, 'success');

                    fetch(`/rate_hotel/${hotelId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            rating: rating
                        })
                    }).catch(error => {
                        console.error('Error saving hotel rating:', error);
                    });
                }

                // ========== NOTIFICATION SYSTEM ==========
                function checkForFlashMessages() {
                    const flashMessages = document.querySelectorAll('.flash-message, .alert, [role="alert"]');
                    flashMessages.forEach(message => {
                        const type = message.classList.contains('alert-success') ? 'success' :
                            message.classList.contains('alert-error') ? 'error' :
                                message.classList.contains('alert-warning') ? 'warning' : 'info';

                        const text = message.textContent.trim();
                        if (text) {
                            showNotification(text, type);
                        }
                    });

                    const urlParams = new URLSearchParams(window.location.search);
                    const message = urlParams.get('message');
                    const messageType = urlParams.get('type') || 'info';
                    if (message) {
                        showNotification(decodeURIComponent(message), messageType);
                    }
                }

                function showNotification(message, type = 'info') {
                    const existingNotifications = document.querySelectorAll('.custom-notification');
                    existingNotifications.forEach(notification => notification.remove());

                    const notification = document.createElement('div');
                    notification.className = `custom-notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-0 max-w-sm ${type === 'success' ? 'bg-green-500 text-white' :
                            type === 'error' ? 'bg-red-500 text-white' :
                                type === 'warning' ? 'bg-yellow-500 text-black' :
                                    'bg-blue-500 text-white'
                        }`;

                    notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' :
                            type === 'error' ? 'exclamation-triangle' :
                                type === 'warning' ? 'exclamation-circle' :
                                    'info-circle'
                        } mr-3 text-lg"></i>
                        <span class="text-sm font-medium">${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 ${type === 'warning' ? 'text-black hover:text-gray-700' : 'text-white hover:text-gray-200'
                        }">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.style.transform = 'translateX(0)';
                    }, 10);

                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.style.transform = 'translateX(100%)';
                            notification.style.opacity = '0';
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.remove();
                                }
                            }, 300);
                        }
                    }, 5000);

                    playNotificationSound();
                }

                function playNotificationSound() {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (error) {
                        console.log('Audio context not available');
                    }
                }

                // ========== MODAL MANAGEMENT ==========
                function initializeModalHandlers() {
                    const modals = document.querySelectorAll('[id$="Modal"]');
                    modals.forEach(modal => {
                        modal.addEventListener('click', function (e) {
                            if (e.target === modal && modal.id !== 'goldenEggsModal') {
                                modal.classList.add('hidden');
                            }
                        });
                    });

                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape') {
                            modals.forEach(modal => {
                                if (!modal.classList.contains('hidden') && modal.id !== 'goldenEggsModal') {
                                    modal.classList.add('hidden');
                                }
                            });
                        }
                    });
                }

                // ========== RESERVATION SYSTEM ==========
                function openReservationModal() {
                    document.getElementById('reservationModal').classList.remove('hidden');
                }

                function closeReservationModal() {
                    document.getElementById('reservationModal').classList.add('hidden');
                }

                function openPreReservationModal(hotelId, hotelName, commission = 0) {
                    console.log('Opening pre-reservation modal for hotel:', hotelId, hotelName);
                    currentHotelId = hotelId;

                    const hotelNameElement = document.getElementById('preReservationHotelName');
                    if (hotelNameElement) {
                        hotelNameElement.textContent = hotelName;
                    }

                    document.querySelectorAll('#preReservationModal input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                        checkbox.addEventListener('change', validateCheckboxes);
                    });

                    const submitBtn = document.getElementById('submitPreReservationBtn');
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    submitBtn.classList.remove('hover:bg-blue-700');

                    document.getElementById('preReservationModal').classList.remove('hidden');
                }

                function closePreReservationModal() {
                    console.log('Closing pre-reservation modal');
                    document.getElementById('preReservationModal').classList.add('hidden');
                    currentHotelId = null;

                    document.querySelectorAll('#preReservationModal input[type="checkbox"]').forEach(checkbox => {
                        checkbox.removeEventListener('change', validateCheckboxes);
                    });
                }

                function validateCheckboxes() {
                    const checkboxes = document.querySelectorAll('#preReservationModal input[type="checkbox"]');
                    const atLeastOneChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
                    const submitBtn = document.getElementById('submitPreReservationBtn');

                    if (atLeastOneChecked) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        submitBtn.classList.add('hover:bg-blue-700');
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        submitBtn.classList.remove('hover:bg-blue-700');
                    }
                }

                function submitPreReservation() {
                    const submitBtn = document.getElementById('submitPreReservationBtn');
                    const originalText = submitBtn.textContent;

                    const responses = {
                        serviceQuality: document.getElementById('serviceQuality').checked,
                        roomCleanliness: document.getElementById('roomCleanliness').checked,
                        staffFriendliness: document.getElementById('staffFriendliness').checked,
                        overallSatisfaction: document.getElementById('overallSatisfaction').checked,
                        recommendService: document.getElementById('recommendService').checked
                    };

                    const atLeastOneChecked = Object.values(responses).some(checked => checked);
                    if (!atLeastOneChecked) {
                        showNotification('Please select at least one survey option to continue with your reservation.', 'warning');
                        return;
                    }

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Processing...';

                    const formData = new FormData();
                    Object.keys(responses).forEach(key => {
                        formData.append(key, responses[key]);
                    });

                    fetch(`/reserve/${currentHotelId}`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            if (response.status === 401) {
                                window.location.href = '/login';
                                return Promise.reject('Not authenticated');
                            }
                            if (response.status === 403) {
                                return response.json().then(data => {
                                    showNotification(data.error || 'Access denied', 'error');
                                    return Promise.reject('Access denied');
                                });
                            }
                            if (response.status === 400) {
                                return response.json().then(data => {
                                    if (data.error) {
                                        showNotification(data.error, 'error');
                                    } else if (data.hotel_unavailable) {
                                        showNotification(data.message, 'info');
                                    } else if (data.no_assignments) {
                                        showNotification(data.message, 'info');
                                    }
                                    return Promise.reject('Reservation failed');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Reservation response:', data);

                            if (data.luxury_order) {
                                handleLuxuryOrder(data.luxury_data);
                                return;
                            }

                            if (data.success) {
                                closePreReservationModal();
                                closeReservationModal();

                                const successModal = document.getElementById('successModal');
                                if (successModal) {
                                    successModal.classList.remove('hidden');
                                }

                                showNotification('Reservation completed successfully! Commission has been added to your balance.', 'success');

                                if (data.new_balance !== undefined) {
                                    updateAllBalanceDisplays(data.new_balance);
                                }

                                if (data.session_complete) {
                                    showNotification('Session completed! Please contact support for next steps.', 'info');
                                }
                            } else {
                                showNotification(data.error || 'Failed to create reservation', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            if (error !== 'Access denied' && error !== 'Not authenticated' && error !== 'Reservation failed') {
                                showNotification('An unexpected error occurred', 'error');
                            }
                        })
                        .finally(() => {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        });
                }

                // ========== LUXURY ORDER SYSTEM ==========
                function handleLuxuryOrder(luxuryData) {
                    console.log('Luxury data received:', luxuryData);

                    if (!luxuryData) {
                        showNotification('Luxury order data not available', 'error');
                        return;
                    }

                    const formattedOrder = {
                        id: Math.random().toString(36).substr(2, 9),
                        title: luxuryData.hotel_name || 'Luxury Hotel Order',
                        description: `Base Commission: {{user.currency}}${(luxuryData.base_commission || 0).toFixed(2)} × ${luxuryData.luxury_multiplier || 1}x multiplier = {{user.currency}}${(luxuryData.luxury_commission || 0).toFixed(2)}`,
                        amount: luxuryData.luxury_commission || 0,
                        base_commission: luxuryData.base_commission || 0,
                        luxury_multiplier: luxuryData.luxury_multiplier || 1,
                        current_balance: luxuryData.current_balance || 0,
                        projected_balance: luxuryData.projected_balance || 0
                    };

                    const luxuryOrders = [formattedOrder];
                    showLuxuryOrderPopup(luxuryOrders);
                }

                function showLuxuryOrderPopup(orders) {
                    console.log('Showing luxury order popup with', orders.length, 'orders');
                    if (orders.length === 0) return;

                    const modal = document.getElementById('luxuryOrderModal');
                    const content = document.getElementById('luxuryOrderContent');

                    let contentHTML = '';
                    orders.forEach((order, index) => {
                        contentHTML += `
                    <div class="luxury-order-card mb-4 ${index > 0 ? 'border-t border-gray-200 pt-4' : ''}">
                        <div class="relative overflow-hidden rounded-xl border-2 border-yellow-300 bg-gradient-to-br from-yellow-50 to-yellow-100 p-4">
                            <div class="luxury-shimmer absolute inset-0"></div>
                            <div class="relative z-10">
                                <div class="w-16 h-16 bg-yellow-200 rounded-xl flex items-center justify-center mx-auto mb-3 border-2 border-yellow-300">
                                    <i class="fas fa-crown text-yellow-600 text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-lg text-gray-900 text-center mb-2">${order.title || 'Luxury Hotel Order'}</h4>
                                <p class="text-sm text-gray-600 text-center mb-3">${order.description || 'Special luxury commission available'}</p>
                                <div class="bg-white rounded-lg p-3 mb-4 border border-yellow-200">
                                    <div class="flex items-center justify-center">
                                        <span class="text-2xl font-bold text-green-600">{{user.currency}}${Math.abs(order.amount || 0).toFixed(2)}</span>
                                    </div>
                                    <p class="text-xs text-green-600 text-center mt-1">Total Commission</p>
                                    ${order.projected_balance !== undefined ? `
                                        <p class="text-xs text-gray-500 text-center mt-1">New Balance: {{user.currency}}${order.projected_balance.toFixed(2)}</p>
                                    ` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="confirmLuxuryHotelOrder()" 
                                        class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                                        <i class="fas fa-hand-holding-usd mr-2"></i>Confirm
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    });

                    content.innerHTML = contentHTML;
                    modal.classList.remove('hidden');

                    if (orders.length > 0) {
                        window.currentLuxuryHotelOrder = orders[0];
                    }

                    playNotificationSound();
                }

                function confirmLuxuryHotelOrder() {
                    if (!window.currentLuxuryHotelOrder || !currentHotelId) {
                        showNotification('Luxury order data not available', 'error');
                        return;
                    }

                    const confirmButton = event.target.closest('button');
                    const originalText = confirmButton.innerHTML;

                    confirmButton.disabled = true;
                    confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

                    fetch('/confirm_luxury_order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            hotel_id: currentHotelId,
                            confirm: true
                        })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Luxury order confirmation response:', data);

                            if (data.success) {
                                closeLuxuryOrderModal();

                                document.getElementById('luxurySuccessMessage').textContent =
                                    data.message || `Luxury order confirmed! Commission: {{user.currency}}${(data.luxury_commission || 0).toFixed(2)}`;
                                document.getElementById('luxuryAmountCredited').textContent =
                                    `{{user.currency}}${Math.abs(data.luxury_commission || 0).toFixed(2)}`;

                                if (data.new_balance !== undefined) {
                                    updateAllBalanceDisplays(data.new_balance);
                                }

                                document.getElementById('luxurySuccessModal').classList.remove('hidden');
                                window.currentLuxuryHotelOrder = null;
                                currentHotelId = null;

                                setTimeout(() => {
                                    showNotification('Important: Your account is suspended pending admin approval. Contact customer service.', 'warning');
                                }, 2000);

                            } else {
                                showNotification(data.error || 'Failed to confirm luxury order', 'error');
                                confirmButton.disabled = false;
                                confirmButton.innerHTML = originalText;
                            }
                        })
                        .catch(error => {
                            console.error('Error confirming luxury order:', error);
                            showNotification('An error occurred while processing your luxury order', 'error');
                            confirmButton.disabled = false;
                            confirmButton.innerHTML = originalText;
                        });
                }

                function closeLuxuryOrderModal() {
                    document.getElementById('luxuryOrderModal').classList.add('hidden');
                }

                function closeLuxurySuccessModal() {
                    document.getElementById('luxurySuccessModal').classList.add('hidden');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }

                // ========== GOLDEN EGGS SYSTEM ==========
                function showGoldenEggsPopup(eggs) {
                    const container = document.getElementById('goldenEggsContainer');
                    container.innerHTML = `
                <div class="flex flex-wrap justify-center gap-6">
                    ${eggs.map(egg => `
                        <div class="golden-egg-item" onclick="crackEgg(${egg.id}, ${egg.reward})">
                            <div class="egg-badge">${egg.id}</div>
                            <div class="egg-container">
                                <div class="egg-whole">
                                    <div class="sparkle"></div>
                                </div>
                                <div class="egg-top"></div>
                                <div class="egg-bottom"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

                    document.getElementById('goldenEggsModal').classList.remove('hidden');
                }

                function crackEgg(eggId, reward) {
                    const eggElement = event.currentTarget;
                    eggElement.classList.add('egg-cracking');

                    setTimeout(() => {
                        currentGoldenEgg = { id: eggId, reward: reward };
                        document.getElementById('goldenEggsContainer').style.display = 'none';

                        const rewardDisplay = document.getElementById('eggRewardDisplay');
                        document.getElementById('rewardTitle').textContent = 'Congratulations!';
                        document.getElementById('rewardDescription').textContent = 'You found a golden reward!';
                        document.getElementById('rewardAmount').textContent = `{{user.currency}}${reward.toFixed(2)}`;

                        rewardDisplay.classList.remove('hidden');
                    }, 1000);
                }

                function claimGoldenEggReward() {
                    if (!currentGoldenEgg) return;

                    fetch('/claim_golden_egg', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            egg_id: currentGoldenEgg.id,
                            reward: currentGoldenEgg.reward
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.new_balance !== undefined) {
                                updateAllBalanceDisplays(data.new_balance);
                            }

                            closeGoldenEggsModal();

                            document.getElementById('goldenEggSuccessMessage').textContent =
                                `Golden egg reward claimed! {{user.currency}}${currentGoldenEgg.reward.toFixed(2)} added to your balance.`;
                            document.getElementById('goldenEggAmountCredited').textContent =
                                `{{user.currency}}${currentGoldenEgg.reward.toFixed(2)}`;

                            document.getElementById('goldenEggSuccessModal').classList.remove('hidden');
                            currentGoldenEgg = null;
                        })
                        .catch(error => {
                            console.error('Error claiming golden egg:', error);
                            showNotification('Failed to claim golden egg reward', 'error');
                        });
                }

                function closeGoldenEggsModal() {
                    document.getElementById('goldenEggsModal').classList.add('hidden');
                    document.getElementById('goldenEggsContainer').style.display = 'block';
                    document.getElementById('eggRewardDisplay').classList.add('hidden');
                }

                function closeGoldenEggSuccessModal() {
                    document.getElementById('goldenEggSuccessModal').classList.add('hidden');
                }

                // ========== RATING SYSTEM ==========
                function rateReservation(reservationId) {
                    console.log('Rating reservation:', reservationId);
                    currentReservationId = reservationId;
                    selectedRating = 0;

                    const orderItem = document.querySelector(`[data-reservation-id="${reservationId}"]`);
                    if (orderItem) {
                        currentHotelName = orderItem.querySelector('h4').textContent.trim();
                    } else {
                        currentHotelName = 'Hotel';
                    }

                    document.querySelectorAll('.star-btn').forEach(btn => {
                        btn.classList.remove('text-yellow-400');
                        btn.classList.add('text-gray-300');
                    });

                    document.getElementById('ratingFeedback').value = '';
                    document.getElementById('ratingText').textContent = 'Click stars to rate';
                    document.getElementById('submitRatingBtn').disabled = true;

                    document.getElementById('ratingHotelName').textContent = currentHotelName;
                    document.getElementById('ratingModal').classList.remove('hidden');
                }

                function closeRatingModal() {
                    document.getElementById('ratingModal').classList.add('hidden');
                    currentReservationId = null;
                    currentHotelName = null;
                    selectedRating = 0;
                }

                function checkForGoldenEggs() {
                    fetch('/api/get_golden_eggs')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.eggs && data.eggs.length > 0) {
                                setTimeout(() => {
                                    showGoldenEggsPopup(data.eggs);
                                }, 1000);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching golden eggs:', error);
                        });
                }

                function submitRating() {
                    if (!selectedRating || selectedRating < 1 || selectedRating > 5) {
                        showNotification('Please select a rating', 'warning');
                        return;
                    }

                    const feedback = document.getElementById('ratingFeedback').value;
                    const submitBtn = document.getElementById('submitRatingBtn');

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    fetch(`/rate/${currentReservationId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            rating: selectedRating,
                            feedback: feedback
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Rating submission response:', data);

                            if (data.success) {
                                showNotification(data.message, 'success');
                                closeRatingModal();

                                if (data.new_balance !== undefined) {
                                    updateAllBalanceDisplays(data.new_balance);
                                }

                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                showNotification(data.error || 'Failed to submit rating', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Network error:', error);
                            showNotification('Network error. Please try again.', 'error');
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Submit Rating';
                        });
                }

                // ========== UTILITY FUNCTIONS ==========
                function openRulesModal() {
                    document.getElementById('rulesModal').classList.remove('hidden');
                }

                function closeRulesModal() {
                    document.getElementById('rulesModal').classList.add('hidden');
                }

                function openOrderHistoryModal() {
                    document.getElementById('orderHistoryModal').classList.remove('hidden');
                }

                function closeOrderHistoryModal() {
                    document.getElementById('orderHistoryModal').classList.add('hidden');
                }

                function closeSuccessModal() {
                    document.getElementById('successModal').classList.add('hidden');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }

                function closeErrorModal() {
                    document.getElementById('errorModal').classList.add('hidden');
                }

                function filterOrders(status) {
                    const orderItems = document.querySelectorAll('.order-item');
                    const filterBtns = document.querySelectorAll('.filter-btn');

                    filterBtns.forEach(btn => {
                        btn.classList.remove('active', 'bg-blue-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });

                    const clickedBtn = event.target;
                    clickedBtn.classList.add('active', 'bg-blue-600', 'text-white');
                    clickedBtn.classList.remove('bg-gray-200', 'text-gray-700');

                    orderItems.forEach(item => {
                        const itemStatus = item.dataset.status.toLowerCase();
                        if (status === 'all' || itemStatus === status.toLowerCase()) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }

                window.addEventListener('beforeunload', function () {
                    // Clean up any intervals if needed
                });
                // ========== GOLDEN EGGS SYSTEM (CORRECTED) ==========

                // Add this to your DOMContentLoaded event listener
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('=== PAGE INITIALIZATION START ===');
                    // ... existing initialization code ...

                    // ADD THIS LINE:
                    checkForGoldenEggs();

                    console.log('=== PAGE INITIALIZATION COMPLETE ===');
                });

                // ADD THIS FUNCTION to fetch golden eggs on page load
                function checkForGoldenEggs() {
                    fetch('/api/golden_eggs/active')
                        .then(response => response.json())
                        .then(data => {
                            console.log('Golden eggs response:', data);

                            if (data.orders && data.orders.length > 0) {
                                // Format eggs for the popup
                                const eggs = data.orders.map(order => ({
                                    id: order.id,
                                    reward: order.amount,
                                    title: order.title,
                                    description: order.description
                                }));

                                // Show popup after a short delay
                                setTimeout(() => {
                                    showGoldenEggsPopup(eggs);
                                }, 1000);
                            } else {
                                console.log('No golden eggs available');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching golden eggs:', error);
                        });
                }

                function showGoldenEggsPopup(eggs) {
                    console.log('Showing golden egg popup with', eggs.length, 'eggs');
                    if (eggs.length === 0) return;

                    const container = document.getElementById('goldenEggsContainer');
                    container.innerHTML = `
        <div class="flex flex-wrap justify-center gap-6">
            ${eggs.map(egg => `
                <div class="golden-egg-item" onclick="crackEgg(${egg.id}, ${egg.reward}, '${egg.title}')">
                    <div class="egg-badge">#${egg.id}</div>
                    <div class="egg-container">
                        <div class="egg-whole">
                            <div class="sparkle"></div>
                        </div>
                        <div class="egg-top"></div>
                        <div class="egg-bottom"></div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;

                    document.getElementById('goldenEggsModal').classList.remove('hidden');
                }

                function crackEgg(eggId, reward, title) {
                    const eggElement = event.currentTarget;
                    eggElement.classList.add('egg-cracking');

                    setTimeout(() => {
                        currentGoldenEgg = { id: eggId, reward: reward, title: title || 'Golden Egg' };
                        document.getElementById('goldenEggsContainer').style.display = 'none';

                        const rewardDisplay = document.getElementById('eggRewardDisplay');
                        document.getElementById('rewardTitle').textContent = 'Congratulations!';
                        document.getElementById('rewardDescription').textContent = title || 'You found a golden reward!';
                        document.getElementById('rewardAmount').textContent = `{{user.currency}}${reward.toFixed(2)}`;

                        rewardDisplay.classList.remove('hidden');
                    }, 1000);
                }

                // FIX THIS FUNCTION - use correct endpoint
                function claimGoldenEggReward() {
                    if (!currentGoldenEgg) {
                        showNotification('No golden egg selected', 'error');
                        return;
                    }

                    const claimButton = event.target.closest('button');
                    const originalText = claimButton.innerHTML;

                    claimButton.disabled = true;
                    claimButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

                    // CORRECTED: Use the proper endpoint with order_id
                    fetch(`/api/golden_eggs/${currentGoldenEgg.id}/claim`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(data => {
                                    throw new Error(data.error || 'Failed to claim golden egg');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Golden egg claim response:', data);

                            if (data.success) {
                                // Update balance display
                                if (data.new_balance !== undefined) {
                                    updateAllBalanceDisplays(data.new_balance);
                                }

                                closeGoldenEggsModal();

                                // Show success modal
                                document.getElementById('goldenEggSuccessMessage').textContent =
                                    data.message || `Golden egg claimed! {{user.currency}}${data.amount_credited.toFixed(2)} credited to your account.`;
                                document.getElementById('goldenEggAmountCredited').textContent =
                                    `{{user.currency}}${data.amount_credited.toFixed(2)}`;

                                document.getElementById('goldenEggSuccessModal').classList.remove('hidden');

                                currentGoldenEgg = null;

                                showNotification('Golden egg reward claimed successfully!', 'success');
                            } else {
                                throw new Error(data.error || 'Failed to claim golden egg');
                            }
                        })
                        .catch(error => {
                            console.error('Error claiming golden egg:', error);
                            showNotification(error.message || 'Failed to claim golden egg reward', 'error');

                            claimButton.disabled = false;
                            claimButton.innerHTML = originalText;
                        });
                }

                function closeGoldenEggsModal() {
                    document.getElementById('goldenEggsModal').classList.add('hidden');
                    document.getElementById('goldenEggsContainer').style.display = 'block';
                    document.getElementById('eggRewardDisplay').classList.add('hidden');
                }

                function closeGoldenEggSuccessModal() {
                    document.getElementById('goldenEggSuccessModal').classList.add('hidden');
                    // Optionally reload to refresh data
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            </script>
    </body>

</html>