<!-- templates/admin_user_details.html -->
{% extends "admin_base.html" %}

{% block title %}User Details - {{ user.nickname }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">User Details - {{ user.contact }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin_settings') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Users
        </a>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="row">
    <!-- User Information -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">User Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Username:</strong> {{ user.nickname }}</p>
                        <p><strong>contact:</strong> {{ user.user_id }}</p>
                        <p><strong>Full Name:</strong> {{ user.full_name or 'Not provided' }}</p>
                        <p><strong>Phone:</strong> {{ user.contact or 'Not provided' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Balance:</strong> Â£{{ "%.2f"|format(user.balance) }}</p>
                        <p><strong>VIP Level:</strong>
                            <span
                                class="badge bg-{{ 'primary' if user.vip_level == 'vip3' else ('info' if user.vip_level == 'vip2' else ('warning' if user.vip_level == 'vip1' else 'secondary')) }}">
                                {{ user.vip_level.upper() if user.vip_level else 'VIP0' }}
                            </span>
                        </p>
                        <p><strong>Status:</strong>
                            <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                        </p>
                        <p><strong>Created:</strong>
                            {{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'N/A' }}
                        </p>
                        <p><strong>Last Login:</strong>
                            {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Adjustment -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Balance Adjustment</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}" class="mt-3">

                    <input type="hidden" name="action" value="adjust_balance" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adjustment_type" class="form-label">Adjustment Type</label>
                                <select class="form-select" id="adjustment_type" name="adjustment_type" required>
                                    <option value="">Select Type</option>
                                    <option value="add">Add to Balance</option>
                                    <option value="subtract">Subtract from Balance</option>
                                    <option value="set">Set Balance</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount</label>
                                <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0"
                                    required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason (Optional)</label>
                        <textarea class="form-control" id="reason" name="reason" rows="2"
                            placeholder="Enter reason for balance adjustment"></textarea>
                    </div>

                    <button type="submit" class="btn btn-warning"
                        onclick="return confirm('Are you sure you want to adjust this user\'s balance?')">
                        Adjust Balance
                    </button>
                </form>
            </div>
        </div>

        <!-- VIP Level Management -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">VIP Level Management</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vip_level" class="form-label">Current VIP Level:
                                    <span
                                        class="badge bg-{{ 'primary' if user.vip_level == 'vip3' else ('info' if user.vip_level == 'vip2' else ('warning' if user.vip_level == 'vip1' else 'secondary')) }}">
                                        {{ user.vip_level.upper() if user.vip_level else 'VIP0' }}
                                    </span>
                                </label>
                                <select class="form-select" id="vip_level" name="vip_level" required>
                                    <option value="">Select New VIP Level</option>
                                    {% for level in ['vip0', 'vip1', 'vip2', 'vip3'] %}
                                    <option value="{{ level }}" {{ 'selected' if user.vip_level==level else '' }}>
                                        {{ level.upper() }}
                                        {% if level == 'vip0' %}(Basic)
                                        {% elif level == 'vip1' %}(Bronze)
                                        {% elif level == 'vip2' %}(Silver)
                                        {% elif level == 'vip3' %}(Gold)
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <button type="submit" class="btn btn-primary"
                                    onclick="return confirm('Are you sure you want to update this user\'s VIP level?')">
                                    <i class="fas fa-crown"></i> Update VIP Level
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                <strong>VIP Level Benefits:</strong><br>
                                <i class="fas fa-circle text-secondary"></i> VIP0 (Basic): Standard benefits<br>
                                <i class="fas fa-circle text-warning"></i> VIP1 (Bronze): 5% bonus on deposits<br>
                                <i class="fas fa-circle text-info"></i> VIP2 (Silver): 10% bonus + priority support<br>
                                <i class="fas fa-circle text-primary"></i> VIP3 (Gold): 15% bonus + exclusive perks
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Create Luxury Order Form -->
        <div class="card mt-3">
            <div class="card-header mb-6">
                <h5 class="card-title">
                    <i class="fas fa-gem text-purple-600 mr-3"></i>
                    Create Luxury Order for {{ user.contact }}
                </h5>
                <p class="text-gray-600 mt-2">Create a special order that this user can claim. Use positive amounts for credits
                    or negative amounts for deductions.</p>
            </div>
        
            <form id="luxuryOrderForm" class="card-body space-y-6">
                <!-- Hidden user ID field -->
                <input type="hidden" name="user_id" id="userId" value="{{ user.id }}">
        
                <!-- Order Title -->
                <div>
                    <label for="orderTitle" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tag mr-1"></i>
                        Order Title *
                    </label>
                    <input type="text" id="orderTitle" name="title" required maxlength="255"
                        placeholder="e.g., VIP Bonus Reward, Account Adjustment, Special Achievement Prize"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    
        
                <!-- Description -->
                <div>
                    <label for="orderDescription" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left mr-1"></i>
                        Description
                    </label>
                    <textarea id="orderDescription" name="description" rows="3"
                        placeholder="Optional description of the luxury order..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
        
                <!-- Amount -->
                <div>
                    <label for="orderAmount" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-dollar-sign mr-1"></i>
                        Amount * (Â£)
                    </label>
                    <input type="number" id="orderAmount" name="amount" required step="0.01"
                        placeholder="e.g., 100.00 (credit) or -50.00 (deduction)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <p class="text-xs text-gray-500 mt-1">
                        <span class="text-green-600">Positive amounts</span> will be credited to user's account.
                        <span class="text-red-600">Negative amounts</span> will be deducted from user's account.
                    </p>
                </div>
                    <div>
                       <input type="number" step="0.01" min="0" name="freezing_amount" id="freezing_amount" placeholder="Enter freezing amount" class="form-control">
                    </div>
                <!-- Order Type Indicator -->
                <div id="amountTypeIndicator" class="hidden">
                    <div id="creditIndicator" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-plus-circle text-green-600 mr-2"></i>
                            <span class="text-green-800 font-medium">Credit Order</span>
                            <span class="text-green-600 ml-auto" id="creditAmount"></span>
                        </div>
                        <p class="text-sm text-green-700 mt-1">This amount will be added to the user's balance when claimed.</p>
                    </div>
                    <div id="deductionIndicator" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-minus-circle text-red-600 mr-2"></i>
                            <span class="text-red-800 font-medium">Deduction Order</span>
                            <span class="text-red-600 ml-auto" id="deductionAmount"></span>
                        </div>
                        <p class="text-sm text-red-700 mt-1">This amount will be deducted from the user's balance when claimed.
                        </p>
                    </div>
                </div>
        
                <!-- Image URL -->
                <div>
                    <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-image mr-1"></i>
                        Image URL
                    </label>
                    <input type="url" id="imageUrl" name="image_url" placeholder="https://example.com/luxury-image.jpg"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    <p class="text-xs text-gray-500 mt-1">Optional image to display in the luxury order popup</p>
                </div>
        
                <!-- Expiration -->
                <div>
                    <label for="expiresIn" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-clock mr-1"></i>
                        Expires In (Hours)
                    </label>
                    <select id="expiresIn" name="expires_in_hours"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">Never expires</option>
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">24 hours</option>
                        <option value="48">48 hours</option>
                        <option value="72">72 hours</option>
                        <option value="168">1 week</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Leave empty for no expiration</p>
                </div>
        
                <!-- Quick Amount Buttons -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quick Amount Selection:</label>
        
                    <!-- Credit Amounts -->
                    <div class="mb-3">
                        <span class="text-sm text-green-600 font-medium">Credits:</span>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button type="button" onclick="setAmount(10)" class="btn btn-outline-success btn-sm">+Â£10</button>
                            <button type="button" onclick="setAmount(25)" class="btn btn-outline-success btn-sm">+Â£25</button>
                            <button type="button" onclick="setAmount(50)" class="btn btn-outline-success btn-sm">+Â£50</button>
                            <button type="button" onclick="setAmount(100)" class="btn btn-outline-success btn-sm">+Â£100</button>
                            <button type="button" onclick="setAmount(250)" class="btn btn-outline-success btn-sm">+Â£250</button>
                            <button type="button" onclick="setAmount(500)" class="btn btn-outline-success btn-sm">+Â£500</button>
                        </div>
                    </div>
        
                    <!-- Deduction Amounts -->
                    <div>
                        <span class="text-sm text-red-600 font-medium">Deductions:</span>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button type="button" onclick="setAmount(-10)" class="btn btn-outline-danger btn-sm">-Â£10</button>
                            <button type="button" onclick="setAmount(-25)" class="btn btn-outline-danger btn-sm">-Â£25</button>
                            <button type="button" onclick="setAmount(-50)" class="btn btn-outline-danger btn-sm">-Â£50</button>
                            <button type="button" onclick="setAmount(-100)" class="btn btn-outline-danger btn-sm">-Â£100</button>
                            <button type="button" onclick="setAmount(-250)" class="btn btn-outline-danger btn-sm">-Â£250</button>
                            <button type="button" onclick="setAmount(-500)" class="btn btn-outline-danger btn-sm">-Â£500</button>
                        </div>
                    </div>
                </div>
        
                <!-- User Balance Warning -->
                <div id="balanceWarning" class="hidden p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-0.5"></i>
                        <div>
                            <span class="text-yellow-800 font-medium">Balance Warning</span>
                            <p class="text-sm text-yellow-700 mt-1">
                                User's current balance: <span class="font-semibold">Â£{{ "%.2f"|format(user.balance) }}</span>
                            </p>
                            <p class="text-sm text-yellow-700" id="balanceWarningText"></p>
                        </div>
                    </div>
                </div>
        
                <!-- Submit Buttons -->
                <div class="flex items-center justify-between pt-4 border-t border-blue-200">
                    <button type="button" onclick="previewOrder()" class="btn btn-primary">
                        <i class="fas fa-eye mr-2"></i>
                        Preview
                    </button>
        
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-gem mr-2"></i>
                        Create Luxury Order
                    </button>
                </div>
            </form>
        
            <!-- Status Messages -->
            <div id="orderStatus" class="mt-4 hidden">
                <div id="orderSuccess" class="hidden p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="successMessage"></span>
                </div>
                <div id="orderError" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        
            <!-- Preview Modal -->
            <div id="previewModal" class="fixed inset-0 bg-primary bg-opacity-50 hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="text-lg font-semibold">Preview Luxury Order</h5>
                                <button onclick="closePreview()" class="text-white-400 hover:text-white-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="previewContent" class="text-center">
                                <!-- Preview content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Statistics -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ user.bookings|length if user.bookings else 0 }}</h4>
                        <p class="text-muted mb-0">Total Bookings</p>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">Â£{{ "%.2f"|format(user.deposits.map(attribute='amount')|sum if
                            user.deposits else 0) }}</h4>
                        <p class="text-muted mb-0">Total Deposits</p>
                    </div>
                </div>
                <div class="text-center">
                    <p class="mb-1"><strong>VIP Level:</strong></p>
                    <h3
                        class="text-{{ 'primary' if user.vip_level == 'vip3' else ('info' if user.vip_level == 'vip2' else ('warning' if user.vip_level == 'vip1' else 'secondary')) }}">
                        <i class="fas fa-crown"></i> {{ user.vip_level.upper() if user.vip_level else 'VIP0' }}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Panel -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <!-- Quick VIP Level Update -->
                <div class="mb-3">
                    <label class="form-label">Quick VIP Update</label>
                    <div class="btn-group d-grid gap-2" role="group">
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}"
                            style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip0">
                            <button type="submit"
                                class="btn btn-outline-secondary btn-sm {{ 'active' if user.vip_level == 'vip0' else '' }}"
                                onclick="return confirm('Set VIP level to VIP0?')">VIP0</button>
                        </form>
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}"
                            style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip1">
                            <button type="submit"
                                class="btn btn-outline-warning btn-sm {{ 'active' if user.vip_level == 'vip1' else '' }}"
                                onclick="return confirm('Set VIP level to VIP1?')">VIP1</button>
                        </form>
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}"
                            style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip2">
                            <button type="submit"
                                class="btn btn-outline-info btn-sm {{ 'active' if user.vip_level == 'vip2' else '' }}"
                                onclick="return confirm('Set VIP level to VIP2?')">VIP2</button>
                        </form>
                        <form method="POST" action="{{ url_for('update_user_vip', user_id=user.id) }}"
                            style="display: inline;">
                            <input type="hidden" name="vip_level" value="vip3">
                            <button type="submit"
                                class="btn btn-outline-primary btn-sm {{ 'active' if user.vip_level == 'vip3' else '' }}"
                                onclick="return confirm('Set VIP level to VIP3?')">VIP3</button>
                        </form>
                    </div>
                </div>

                <!-- Toggle User Status -->
                <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}" class="mb-3">
                    <input type="hidden" name="action" value="toggle_status" />
                    <button type="submit" class="btn btn-{{ 'danger' if user.is_active else 'success' }} w-100"
                        onclick="return confirm('Are you sure you want to {{ 'deactivate' if user.is_active else 'activate' }} this user?')">
                        {{ 'Deactivate User' if user.is_active else 'Activate User' }}
                    </button>
                </form>

                <!-- Send Message -->
                <button type="button" class="btn btn-info w-100 mb-3" data-bs-toggle="modal"
                    data-bs-target="#messageModal">
                    Send Message
                </button>

                <!-- Reset Password -->
                <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}" class="mb-3">
                    <input type="hidden" name="action" value="reset_password" />
                    <button type="submit" class="btn btn-warning w-100"
                        onclick="return confirm('Are you sure you want to reset this user\'s password? A new temporary password will be generated.')">
                        Reset Password
                    </button>
                </form>

                <!-- Delete User -->
                {% if not user.bookings or user.bookings|length == 0 %}
                <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}">
                    <button type="submit" class="btn btn-danger w-100"
                        onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone!')">
                        Delete User
                    </button>
                </form>
                {% else %}
                <button type="button" class="btn btn-danger w-100" disabled
                    title="Cannot delete user with existing bookings">
                    Delete User
                </button>
                <small class="text-muted">Cannot delete users with bookings</small>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Bookings -->
        <div class="card mt-3 mb-8">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Bookings</h5>
            </div>
            <div class="card-body">
                {% if user.bookings %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Hotel</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Status</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in user.bookings[:5] %}
                            <tr>
                                <td>{{ booking.id }}</td>
                                <td>{{ booking.hotel.name if booking.hotel else 'N/A' }}</td>
                                <td>{{ booking.check_in_date.strftime('%Y-%m-%d') if booking.check_in_date else 'N/A' }}
                                </td>
                                <td>{{ booking.check_out_date.strftime('%Y-%m-%d') if booking.check_out_date else 'N/A' }}
                                </td>
                                <td>
                                    <span
                                        class="badge bg-{{ 'success' if booking.status == 'confirmed' else ('warning' if booking.status == 'pending' else 'danger') }}">
                                        {{ booking.status.title() if booking.status else 'N/A' }}
                                    </span>
                                </td>
                                <td>Â£{{ "%.2f"|format(booking.total_amount) if booking.total_amount else '0.00' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No bookings found for this user.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Member Point Update Form -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    Update Member Points
                </h5>
                <span class="text-sm text-gray-500">Current: <span id="current-member-points"
                        class="font-semibold">{{ user.member_point or 0 }}</span></span>
            </div>

            <form id="memberPointForm" class="card-body space-y-4">
                <input type="hidden" id="memberUserId" value="{{ user.id }}">

                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label for="memberPoint" class="block text-sm font-medium text-gray-700 mb-2">
                            New Member Points
                        </label>
                        <input type="number" id="memberPoint" name="member_point" value="{{ user.member_point or 0 }}"
                            min="0" step="1"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required>
                    </div>

                    <button type="submit"
                        class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        Update
                    </button>
                </div>

                <!-- Quick preset buttons -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm text-gray-600">Quick set:</span>
                    <button type="button" onclick="setMemberPoint(0)"
                        class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">0</button>
                    <button type="button" onclick="setMemberPoint(100)"
                        class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">100</button>
                    <button type="button" onclick="setMemberPoint(500)"
                        class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">500</button>
                    <button type="button" onclick="setMemberPoint(1000)"
                        class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">1000</button>
                    <button type="button" onclick="setMemberPoint(5000)"
                        class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">5000</button>
                </div>
            </form>

            <!-- Status messages -->
            <div id="memberPointStatus" class="mt-3 hidden">
                <div id="memberPointSuccess"
                    class="hidden p-3 bg-green-100 border border-green-400 text-green-700 rounded">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="memberSuccessMessage"></span>
                </div>
                <div id="memberPointError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="memberErrorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('view_user_details', user_id=user.id) }}">
                <input type="hidden" name="action" value="send_message" />

                <div class="modal-header">
                    <h5 class="modal-title">Send Message to {{ user.nickname }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="message_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="message_subject" name="message_subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="message_content" class="form-label">Message</label>
                        <textarea class="form-control" id="message_content" name="message_content" rows="4"
                            required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
   document.addEventListener('DOMContentLoaded', function () {
    const amountInput = document.getElementById('orderAmount');
    const amountTypeIndicator = document.getElementById('amountTypeIndicator');
    const creditIndicator = document.getElementById('creditIndicator');
    const deductionIndicator = document.getElementById('deductionIndicator');
    const creditAmount = document.getElementById('creditAmount');
    const deductionAmount = document.getElementById('deductionAmount');
    const balanceWarning = document.getElementById('balanceWarning');
    const balanceWarningText = document.getElementById('balanceWarningText');

    // Fixed: Properly format the user balance with null checking
    const userBalance = {{ user.balance|default(0)|round(2) }};

    // Add event listener for amount input changes
    if (amountInput) {
        amountInput.addEventListener('input', function () {
            updateAmountIndicator();
            checkBalanceWarning();
        });
    }

    function updateAmountIndicator() {
        const amount = parseFloat(amountInput.value);

        if (isNaN(amount) || amount === 0) {
            amountTypeIndicator.classList.add('hidden');
            creditIndicator.classList.add('hidden');
            deductionIndicator.classList.add('hidden');
            return;
        }

        amountTypeIndicator.classList.remove('hidden');

        if (amount > 0) {
            // Show credit indicator
            creditIndicator.classList.remove('hidden');
            deductionIndicator.classList.add('hidden');
            creditAmount.textContent = `+Â£${amount.toFixed(2)}`;
        } else {
            // Show deduction indicator
            deductionIndicator.classList.remove('hidden');
            creditIndicator.classList.add('hidden');
            deductionAmount.textContent = `Â£${amount.toFixed(2)}`;
        }
    }

    function checkBalanceWarning() {
        const amount = parseFloat(amountInput.value);

        if (isNaN(amount) || amount >= 0) {
            balanceWarning.classList.add('hidden');
            return;
        }

        const deductionAmount = Math.abs(amount);
        const resultingBalance = userBalance + amount; // amount is negative

        if (resultingBalance < 0) {
            balanceWarning.classList.remove('hidden');
            balanceWarningText.textContent = `This deduction would result in a negative balance of Â£${resultingBalance.toFixed(2)}. The user will have insufficient funds.`;
        } else if (deductionAmount > userBalance * 0.8) {
            balanceWarning.classList.remove('hidden');
            balanceWarningText.textContent = `This deduction represents ${((deductionAmount / userBalance) * 100).toFixed(1)}% of the user's current balance.`;
        } else {
            balanceWarning.classList.add('hidden');
        }
    }

    const form = document.getElementById('luxuryOrderForm');
    const statusDiv = document.getElementById('orderStatus');
    const successDiv = document.getElementById('orderSuccess');
    const errorDiv = document.getElementById('orderError');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    if (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Ensure user_id is included
            if (!data.user_id) {
                const userIdField = document.getElementById('userId');
                if (userIdField) {
                    data.user_id = userIdField.value;
                }
            }

            // Validate required fields
            if (!data.user_id || !data.title || !data.amount) {
                showError('Please fill in all required fields (Title, Amount)');
                return;
            }

            // Get freezing amount - MOVED INSIDE THE SUBMIT HANDLER
            const freezingAmountInput = document.getElementById('freezing_amount');
            const freezingAmount = freezingAmountInput ? (parseFloat(freezingAmountInput.value) || 0) : 0;

            // Transform and validate data
            const transformedData = {
                user_id: parseInt(data.user_id),
                title: data.title.trim(),
                description: data.description ? data.description.trim() : '',
                amount: parseFloat(data.amount),
                image_url: data.image_url ? data.image_url.trim() : '',
                expires_in_hours: data.expires_in_hours ? parseInt(data.expires_in_hours) : null,
                freezing_amount: freezingAmount  // ADD FREEZING AMOUNT TO THE DATA
            };

            // Validation
            if (!transformedData.user_id || isNaN(transformedData.user_id)) {
                showError('Invalid user ID');
                return;
            }

            if (isNaN(transformedData.amount) || transformedData.amount === 0) {
                showError('Please enter a valid amount (positive for credit, negative for deduction)');
                return;
            }

            if (transformedData.expires_in_hours && (transformedData.expires_in_hours < 1 || transformedData.expires_in_hours > 168)) {
                showError('Expiration hours must be between 1 and 168 (7 days)');
                return;
            }

            // Validate freezing amount
            if (freezingAmount < 0) {
                showError('Freezing amount cannot be negative');
                return;
            }

            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            }

            hideMessages();

            fetch('/admin/golden_eggs/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(transformedData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showSuccess(data.message || 'Luxury order created successfully!');
                        form.reset();
                        const userIdField = document.getElementById('userId');
                        if (userIdField) {
                            userIdField.value = '{{ user.id }}';
                        }
                        updateAmountIndicator(); // Reset indicators
                        setTimeout(() => hideMessages(), 5000);
                    } else {
                        throw new Error(data.error || data.message || 'Creation failed');
                    }
                })
                .catch(error => {
                    console.error('Error creating luxury order:', error);
                    let errorMsg = 'An error occurred while creating the luxury order';

                    if (error.message.includes('HTTP 404')) {
                        errorMsg = 'Server endpoint not found. Please contact support.';
                    } else if (error.message.includes('HTTP 500')) {
                        errorMsg = 'Server error occurred. Please try again or contact support.';
                    } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                        errorMsg = 'Network error. Please check your connection and try again.';
                    } else if (error.message) {
                        errorMsg = error.message;
                    }

                    showError(errorMsg);
                })
                .finally(() => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-gem mr-2"></i>Create Luxury Order';
                    }
                });
        });
    }

    function showSuccess(message) {
        if (successMessage && successDiv && statusDiv) {
            successMessage.textContent = message;
            successDiv.classList.remove('hidden');
            statusDiv.classList.remove('hidden');
        }
    }

    function showError(message) {
        if (errorMessage && errorDiv && statusDiv) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            statusDiv.classList.remove('hidden');
        }
    }

    function hideMessages() {
        if (statusDiv) statusDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        if (errorDiv) errorDiv.classList.add('hidden');
    }
});

function setAmount(amount) {
    const amountInput = document.getElementById('orderAmount');
    if (amountInput) {
        amountInput.value = parseFloat(amount).toFixed(2);
        // Trigger input event to update indicators
        amountInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}

function previewOrder() {
    const titleInput = document.getElementById('orderTitle');
    const descriptionInput = document.getElementById('orderDescription');
    const amountInput = document.getElementById('orderAmount');
    const imageUrlInput = document.getElementById('imageUrl');
    const expiresInput = document.getElementById('expiresIn');

    if (!titleInput || !amountInput) {
        alert('Form elements not found');
        return;
    }

    const title = titleInput.value.trim();
    const description = descriptionInput ? descriptionInput.value.trim() : '';
    const amount = parseFloat(amountInput.value);
    const imageUrl = imageUrlInput ? imageUrlInput.value.trim() : '';
    const expiresHours = expiresInput && expiresInput.value ? parseInt(expiresInput.value) : null;

    if (!title || isNaN(amount) || amount === 0) {
        alert('Please fill in required fields (Title, Amount) to preview');
        return;
    }

    const isCredit = amount > 0;
    const absAmount = Math.abs(amount);

    const previewContent = `
        <div class="luxury-order-preview">
            ${imageUrl ?
                `<img src="${escapeHtml(imageUrl)}" alt="Luxury Order" class="w-20 h-20 mx-auto mb-4 rounded-lg object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div class="w-20 h-20 mx-auto mb-4 bg-purple-100 rounded-lg flex items-center justify-center" style="display:none;"><i class="fas fa-gem text-purple-500 text-2xl"></i></div>` :
                '<div class="w-20 h-20 mx-auto mb-4 bg-purple-100 rounded-lg flex items-center justify-center"><i class="fas fa-gem text-purple-500 text-2xl"></i></div>'
            }
            <h4 class="text-xl font-bold text-gray-900 mb-2">${escapeHtml(title)}</h4>
            ${description ? `<p class="text-gray-600 mb-4">${escapeHtml(description)}</p>` : ''}
            <div class="border rounded-lg p-3 mb-4 ${isCredit ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300'}">
                <div class="flex items-center justify-center mb-2">
                    <i class="fas ${isCredit ? 'fa-plus-circle text-green-600' : 'fa-minus-circle text-red-600'} mr-2"></i>
                    <span class="text-sm font-medium ${isCredit ? 'text-green-700' : 'text-red-700'}">
                        ${isCredit ? 'Credit Order' : 'Deduction Order'}
                    </span>
                </div>
                <div class="text-2xl font-bold ${isCredit ? 'text-green-600' : 'text-red-600'}">
                    ${isCredit ? '+' : ''}Â£${amount.toFixed(2)}
                </div>
                <div class="text-sm ${isCredit ? 'text-green-700' : 'text-red-700'}">
                    Will be ${isCredit ? 'credited to' : 'deducted from'} account
                </div>
            </div>
            <p class="text-sm text-gray-500">For: {{ user.contact }}</p>
            ${expiresHours ? `<p class="text-xs text-gray-400 mt-2">Expires in: ${expiresHours} hour${expiresHours !== 1 ? 's' : ''}</p>` : '<p class="text-xs text-gray-400 mt-2">Never expires</p>'}
        </div>
    `;

    const previewContentDiv = document.getElementById('previewContent');
    const previewModal = document.getElementById('previewModal');

    if (previewContentDiv && previewModal) {
        previewContentDiv.innerHTML = previewContent;
        previewModal.classList.remove('hidden');
    }
}

function closePreview() {
    const previewModal = document.getElementById('previewModal');
    if (previewModal) {
        previewModal.classList.add('hidden');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
// Member Points Form Handler
document.addEventListener('DOMContentLoaded', function () {
    const memberForm = document.getElementById('memberPointForm');
    const memberPointInput = document.getElementById('memberPoint');
    const userIdInput = document.getElementById('memberUserId');
    const currentPointsSpan = document.getElementById('current-member-points');
    const statusDiv = document.getElementById('memberPointStatus');
    const successDiv = document.getElementById('memberPointSuccess');
    const errorDiv = document.getElementById('memberPointError');
    const successMessage = document.getElementById('memberSuccessMessage');
    const errorMessage = document.getElementById('memberErrorMessage');

    // Check if all required elements exist
    if (!memberForm || !memberPointInput || !userIdInput) {
        console.error('Required member point form elements not found');
        return;
    }

    memberForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const userId = userIdInput.value;
        const newMemberPoint = parseInt(memberPointInput.value);
        const submitButton = memberForm.querySelector('button[type="submit"]');

        // Validation
        if (!userId) {
            showMemberError('User ID is required');
            return;
        }

        if (isNaN(newMemberPoint) || newMemberPoint < 0) {
            showMemberError('Please enter a valid member point value (0 or greater)');
            return;
        }

        // Disable submit button during request
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';

        // Hide previous status messages
        hideMemberMessages();

        console.log('Updating member points:', { userId, newMemberPoint });

        // Make API request
        fetch(`/admin/api/users/${userId}/member_point`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                member_point: newMemberPoint
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update current points display
                if (currentPointsSpan) {
                    currentPointsSpan.textContent = data.new_member_point || newMemberPoint;
                }

                // Show success message
                showMemberSuccess(data.message || 'Member points updated successfully');

                // Auto-hide success message after 3 seconds
                setTimeout(() => hideMemberMessages(), 3000);
            } else {
                throw new Error(data.message || data.error || 'Update failed');
            }
        })
        .catch(error => {
            console.error('Error updating member points:', error);
            
            let errorMsg = 'Failed to update member points';
            
            if (error.message.includes('HTTP 404')) {
                errorMsg = 'User not found or endpoint unavailable';
            } else if (error.message.includes('HTTP 500')) {
                errorMsg = 'Server error occurred. Please try again';
            } else if (error.message.includes('HTTP 403')) {
                errorMsg = 'Permission denied. Please check your access rights';
            } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                errorMsg = 'Network error. Please check your connection';
            } else if (error.message) {
                errorMsg = error.message;
            }
            
            showMemberError(errorMsg);
        })
        .finally(() => {
            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update';
        });
    });

    function showMemberSuccess(message) {
        if (successMessage && successDiv && statusDiv) {
            successMessage.textContent = message;
            successDiv.classList.remove('hidden');
            statusDiv.classList.remove('hidden');
        }
    }

    function showMemberError(message) {
        if (errorMessage && errorDiv && statusDiv) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            statusDiv.classList.remove('hidden');
        }
    }

    function hideMemberMessages() {
        if (statusDiv) statusDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
        if (errorDiv) errorDiv.classList.add('hidden');
    }
});

// Function for quick preset buttons
function setMemberPoint(value) {
    const memberPointInput = document.getElementById('memberPoint');
    if (memberPointInput) {
        memberPointInput.value = parseInt(value);
        // Trigger input event to validate the value
        memberPointInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
}
</script>
{% endblock %}