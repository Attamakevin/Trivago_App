<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="{{ url_for('static', filename='images/ico.png') }}" type="image/x-icon">
        <title>Reservation Center - trivago</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/translate.css') }}">
        <!-- TailwindCSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet">
        <!-- Custom Script -->
        <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>
        <script defer src="{{ url_for('static', filename='js/translate.js') }}"></script>
        <script defer src="{{ url_for('static', filename='js/user.js') }}"></script>
    </head>

    <style>
        /* Golden Egg Styles */
        .golden-egg-item {
            position: relative;
            width: 120px;
            height: 150px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .golden-egg-item:hover {
            transform: translateY(-10px);
        }

        .egg-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .egg-whole {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffd700, #ffed4e, #daa520);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow:
                inset -10px -10px 20px rgba(0, 0, 0, 0.2),
                inset 10px 10px 20px rgba(255, 255, 255, 0.5),
                0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: opacity 0.5s;
        }

        .egg-whole::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 30%;
            height: 40%;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: rotate(25deg);
        }

        .egg-whole::after {
            content: '';
            position: absolute;
            top: 15%;
            right: 25%;
            width: 15%;
            height: 15%;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
        }

        .egg-top,
        .egg-bottom {
            position: absolute;
            width: 100%;
            opacity: 0;
            transition: all 0.5s;
        }

        .egg-top {
            height: 55%;
            top: 0;
            background: linear-gradient(135deg, #ffd700, #ffed4e, #daa520);
            border-radius: 50% 50% 40% 40% / 60% 60% 30% 30%;
            box-shadow: inset -5px -5px 10px rgba(0, 0, 0, 0.2);
            transform-origin: center bottom;
        }

        .egg-bottom {
            height: 55%;
            bottom: 0;
            background: linear-gradient(135deg, #daa520, #ffd700, #ffed4e);
            border-radius: 40% 40% 50% 50% / 30% 30% 60% 60%;
            box-shadow: inset -5px 5px 10px rgba(0, 0, 0, 0.2);
            transform-origin: center top;
        }

        .egg-top::after,
        .egg-bottom::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 20px;
            background: inherit;
        }

        .egg-top::after {
            bottom: -10px;
            clip-path: polygon(0 0, 10% 100%, 20% 0, 30% 100%, 40% 0, 50% 100%, 60% 0, 70% 100%, 80% 0, 90% 100%, 100% 0);
        }

        .egg-bottom::before {
            top: -10px;
            clip-path: polygon(0 100%, 10% 0, 20% 100%, 30% 0, 40% 100%, 50% 0, 60% 100%, 70% 0, 80% 100%, 90% 0, 100% 100%);
        }

        .egg-cracking .egg-whole {
            animation: shake 0.5s;
            opacity: 0;
            transition-delay: 0.4s;
        }

        .egg-cracking .egg-top {
            opacity: 1;
            transform: rotate(-25deg) translateY(-20px);
            transition-delay: 0.5s;
        }

        .egg-cracking .egg-bottom {
            opacity: 1;
            transform: rotate(15deg) translateY(20px);
            transition-delay: 0.5s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px) rotate(-2deg);
            }

            75% {
                transform: translateX(5px) rotate(2deg);
            }
        }

        .sparkle {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .sparkle::before,
        .sparkle::after {
            content: 'âœ¨';
            position: absolute;
            font-size: 20px;
            animation: sparkleFloat 2s infinite;
        }

        .sparkle::before {
            top: 30%;
            left: 20%;
            animation-delay: 0s;
        }

        .sparkle::after {
            top: 50%;
            right: 20%;
            animation-delay: 1s;
        }

        @keyframes sparkleFloat {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0;
            }

            50% {
                transform: translateY(-20px) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-40px) scale(0);
                opacity: 0;
            }
        }

        .egg-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff5722;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
    </style>

    <body class="min-h-screen">
        <!-- Header -->
        <header class="sticky h-16 top-0 z-50 bg-[#2563eb] shadow-sm py-2 md:py-4 px-4 md:px-8">
            <div class="flex items-center justify-start gap-8 text-white h-full">
                <button onclick="history.back()" class="text-white hover:text-blue-200 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 data-translate class="text-white text-sm md:text-md font-bold">Hotel Reservation Center</h1>
            </div>
        </header>

        <div class="px-4 py-6 space-y-8 bg-cover bg-center"
            style="background-image: url('{{ url_for('static', filename='images/hotel-5.jpg') }}')">
            <!-- Reservation Stats Section -->
            <div class="flex flex-col sm:flex-row items-center sm:justify-between p-6">
                <div class="mb-6 bg-white rounded-lg shadow-sm p-4 text ">
                    <div class="text-sm md:text-sm font-bold text-purple-600 mb-2">
                       {{ reservations|length|cycle_reset(70) }}
                    </div>
                    <p data-translate class="text-xs text-gray-700 font-medium">Total Reservations Made</p>
                    <p class="text-xs text-gray-500">VIP Level: <span
                            class="text-lg text-purple-600">{{ user.vip_level }} </span></p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button data-translate onclick="openRulesModal()"
                        class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center">
                        <i class="fas fa-book mr-2"></i>
                        Rules & Guidelines
                    </button>
                    <button data-translate onclick="openOrderHistoryModal()"
                        class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-3 px-6 rounded-xl transition-colors flex items-center justify-center">
                        <i class="fas fa-list-ul mr-2"></i>
                        Order History
                    </button>
                </div>
            </div>

            <!-- Dancing Hotel Logos Section -->
            <div class="p-6 bg-[#101f56] text-[#f7b437] rounded-lg shadow-sm overflow-hidden">
                <h3 data-translate class="text-xl font-bold text-center mb-6">Our Hotel Partners</h3>
                <div class="flex flex-wrap justify-center items-center gap-8 md:gap-12">
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-gray-100 px-1 rounded-xl flex items-center justify-center shadow-lg">
                        <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/626.png"
                            alt="Booking.com" loading="lazy" class="partner-logo">
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-gray-100 px-1 rounded-xl flex items-center justify-center shadow-lg">
                        <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/3340.png"
                            alt="Booking.com" loading="lazy" class="partner-logo">
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-gray-100 px-1 rounded-xl flex items-center justify-center shadow-lg">
                        <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/395.png"
                            alt="Booking.com" loading="lazy" class="partner-logo">
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-gray-100 px-1 rounded-xl flex items-center justify-center shadow-lg">
                        <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/2564.png"
                            alt="Booking.com" loading="lazy" class="partner-logo">
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-gray-100 px-1 rounded-xl flex items-center justify-center shadow-lg">
                        <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/634.png"
                            alt="Booking.com" loading="lazy" class="partner-logo">
                    </div>
                    <div
                        class="hotel-logo w-16 h-16 md:w-20 md:h-20 bg-gray-100 px-1 rounded-xl flex items-center justify-center shadow-lg">
                        <img src="https://imgcy.trivago.com/image/upload/hardcodedimages/mpm-localised-logos-dark/14.png"
                            alt="Booking.com" loading="lazy" class="partner-logo">
                    </div>
                </div>
                <div class="text-center mt-4">
                    <p data-translate class="text-sm">500+ Premium Hotel Partners Worldwide</p>
                </div>
            </div>

            <!-- Main Action Card -->
            <div class="overflow-hidden bg-[#101f56]">
                <!-- Reservation Button -->
                <div class="p-8 text-center">
                    <button data-translate onclick="openReservationModal()"
                        class="bg-[#f7b437] hover:bg-[#f7b437] font-bold py-4 px-8 rounded-xl transition-colors text-sm text-white shadow-lg">
                        Make Reservation
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Trial Bonus -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-40 rounded-full flex items-center justify-center">
                                    <i class="fas fa-gift text-xl"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">â‚¬{{ "%.2f"|format(user_stats.trial_bonus) }}
                            </div>
                            <p data-translate class="text-sm text-[#101f56]">Trial Bonus</p>
                            <!-- <p class="text-xs text-[#101f56] mt-1">Expires in 15 days</p> -->
                        </div>

                        <!-- Account Balance -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-wallet text-xl text-teal-600"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">â‚¬{{ "%.2f"|format(user.balance) }}</div>
                            <div id="userBalance" data-balance="{{user.balance}}" style="display: none;"></div>
                            <p data-translate class="text-[#101f56] text-sm">Account Balance</p>
                            <p data-translate class="text-xs text-[#101f56] mt-1">Available for withdrawal</p>
                        </div>

                        <!-- Earned Commission -->
                        <div class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-xl text-orange-600"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">â‚¬{{user.total_commission_earned}}</div>
                            <p data-translate class="text-[#101f56] text-sm">Earned Commission</p>
                            <p data-translate class="text-xs text-[#101f56] mt-1">Total earnings</p>
                        </div>

                        <!-- Hotel Booking Deposit -->
                        <div id="freezingAmountCard" class="card-hover bg-[#f7b437] rounded-2xl p-6 text-white hidden">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-12 h-12 bg-white bg-opacity-80 rounded-full flex items-center justify-center">
                                    <i class="fas fa-piggy-bank text-xl text-purple-600"></i>
                                </div>
                            </div>
                            <div class="text-xl md:text-xl font-bold mb-1">â‚¬{{ "%.2f"|format(user.total_deposits) }}
                            </div>
                            <p data-translate class="text-[#101f56] text-sm">Freezing Amount</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- LUXURY ORDER POPUP MODAL -->
        <div id="luxuryOrderModal" class="fixed inset-0 bg-black bg-opacity-70 modal z-[100] hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="bg-white rounded-3xl shadow-2xl w-full max-w-md luxury-popup-slide-in relative overflow-hidden">
                    <!-- Luxury Header -->
                    <div class="luxury-gradient p-6 text-white text-center relative overflow-hidden">
                        <div class="luxury-shimmer absolute inset-0"></div>
                        <div class="relative z-10">
                            <div
                                class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-crown text-yellow-300 text-2xl"></i>
                            </div>
                            <h3 data-translate class="text-2xl font-bold mb-2">ðŸŽ‰ Luxury Order Available!</h3>
                            <p data-translate class="text-sm opacity-90">Exclusive opportunity just for you</p>
                        </div>
                        <!-- ... close button ... -->
                    </div>
                    <!-- Luxury Order Content -->
                    <div class="p-6" id="luxuryOrderContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div id="luxurySuccessModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-[110] hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-crown text-yellow-600 text-3xl"></i>
                    </div>
                    <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Luxury Order Claimed!</h3>
                    <p data-translate id="luxurySuccessMessage" class="text-gray-600 mb-6">Your luxury order has been
                        successfully claimed!</p>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-center">
                            <span id="luxuryAmountCredited" class="text-lg font-bold text-green-600">Â£0.00</span>
                        </div>
                        <p data-translate class="text-xs text-green-600 mt-1">Added to your account balance</p>
                    </div>
                    <button onclick="closeLuxurySuccessModal()"
                        class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        <i class="fas fa-trophy mr-2"></i>Awesome!
                    </button>
                </div>
            </div>
        </div>

        <!-- GOLDEN EGGs POPUP MODAL -->
        <div id="goldenEggsModal" class="fixed inset-0 bg-black bg-opacity-70 modal z-[100] hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-3xl shadow-2xl w-full max-w-sm relative overflow-hidden">
                    <!-- Golden Eggs Header -->
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-400 p-4 text-white text-center relative">
                        <button onclick="closeGoldenEggsModal()"
                            class="absolute top-4 right-4 text-white hover:text-yellow-100">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                        <h3 class="text-2xl font-bold mb-1">Golden Eggs Available!</h3>
                        <p class="text-sm opacity-90">Click on an egg to crack it open and reveal your reward!</p>
                    </div>

                    <!-- Golden Eggs Container -->
                    <div class="p-8" id="goldenEggsContainer">
                        <!-- Eggs will be populated by JavaScript -->
                    </div>

                    <!-- Reward Display Area (initially hidden) -->
                    <div id="eggRewardDisplay" class="hidden p-6 text-center">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mx-auto max-w-sm">
                            <div
                                class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-coins text-yellow-600 text-3xl"></i>
                            </div>
                            <h4 id="rewardTitle" class="text-xl font-bold text-gray-900 mb-2"></h4>
                            <p id="rewardDescription" class="text-gray-600 mb-4"></p>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                <span id="rewardAmount" class="text-2xl font-bold text-green-600"></span>
                            </div>
                            <button id="claimRewardBtn" onclick=""
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition-all">
                                <i class="fas fa-hand-holding-usd mr-2"></i>Claim Reward
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="goldenEggSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-[110] hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                    <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-crown text-yellow-600 text-3xl"></i>
                    </div>
                    <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Golden Egg Claimed!</h3>
                    <p data-translate id="goldenEggSuccessMessage" class="text-gray-600 mb-6">Your golden egg has been
                        successfully claimed!</p>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-center">
                            <span id="goldenEggAmountCredited" class="text-lg font-bold text-green-600">Â£0.00</span>
                        </div>
                        <p data-translate class="text-xs text-green-600 mt-1">Added to your account balance</p>
                    </div>
                    <button onclick="closeLuxurySuccessModal()"
                        class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        <i class="fas fa-trophy mr-2"></i>Awesome!
                    </button>
                </div>
            </div>
        </div>
        <!-- Hotel Selection Modal -->
        <div id="reservationModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden overflow-auto">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg slide-up max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 data-translate class="text-xl font-bold text-gray-900">Select Hotel for Reservation</h3>
                            <button onclick="closeReservationModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-6 px-6 py-3">
                            {% if current_hotel_data %}
                            <div
                                class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                                <div class="relative">
                                    <img src="{{ current_hotel_data.hotel.primary_picture }}"
                                        alt="{{ current_hotel_data.hotel.name }}" class="w-full h-48 object-cover">
                                    <div
                                        class="absolute top-3 right-3 bg-green-500 capitalize text-white px-2 py-1 rounded-full text-sm font-medium">
                                        {{ current_hotel_data.hotel.category }}
                                    </div>
                                    <!-- Commission Badge -->
                                    <div
                                        class="absolute top-3 left-3 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                        â‚¬{{ "%.2f"|format(current_hotel_data.commission) }} Commission
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h4 class="font-bold text-lg text-gray-900 mb-2">{{ current_hotel_data.hotel.name }}
                                    </h4>
                                    <div class="flex items-center justify-between mb-3">
                                        <p class="text-gray-600 text-sm mb-3">{{ current_hotel_data.hotel.location }}
                                        </p>
                                        <span class="text-lg font-bold text-green-600">â‚¬{{
                                            "%.2f"|format(current_hotel_data.hotel.price) }}</span>
                                    </div>
                                    <!-- Assignment Info -->
                                    {% if current_hotel_data.assigned_at %}
                                    <div class="text-xs text-gray-500 mb-2">
                                        <i class="fas fa-calendar-alt mr-1"></i>
                                        Assigned: {{ current_hotel_data.assigned_at.strftime('%B %d, %Y') }}
                                    </div>
                                    {% endif %}

                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <!-- Clickable Star Rating Display -->
                                            <div class="flex items-center">
                                                {% for i in range(5) %}
                                                <button type="button"
                                                    class="hotel-star-btn text-2xl transition-colors duration-200 {% if i < current_hotel_data.hotel.rating|round|int %}text-yellow-400{% else %}text-gray-300{% endif %}"
                                                    data-hotel-id="{{ current_hotel_data.hotel.id }}"
                                                    data-rating="{{ i + 1 }}"
                                                    onclick="rateHotel({{ current_hotel_data.hotel.id }}, {{ i + 1 }})">
                                                    <i class="fas fa-star text-4xl"></i>
                                                </button>
                                                {% endfor %}
                                                <span class="ml-2 text-sm text-gray-600">({{
                                                    "%.1f"|format(current_hotel_data.hotel.rating) }})</span>
                                            </div>
                                        </div>

                                    </div>

                                    <!-- Commission Details -->
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-blue-800">
                                                Your Commission
                                            </span>
                                            <span class="text-lg font-bold text-blue-600">
                                                â‚¬{{ "%.2f"|format(current_hotel_data.commission) }}
                                                x
                                                {{ "%.2f"|format(current_hotel_data.hotel.commission_multiplier or 1.0) }}
                                            </span>

                                        </div>

                                        <p data-translate class="text-xs text-blue-600 mt-1">

                                            Earn this amount when you complete your reservation and rating
                                        </p>
                                    </div>

                                    <form method="POST"
                                        action="{{ url_for('reserve', hotel_id=current_hotel_data.hotel.id) }}"
                                        class="w-full">
                                        <button data-translate type="button"
                                            onclick="openPreReservationModal({{ current_hotel_data.hotel.id }}, '{{ current_hotel_data.hotel.name }}', {{ current_hotel_data.commission }})"
                                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                            <i class="fas fa-calendar-plus mr-2"></i>Reserve Now
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <!-- Show when using legacy hotels list (fallback) -->
                            {% for hotel in hotels %}
                            <div
                                class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                                <div class="relative">
                                    <img src="{{ url_for('static', filename='images/hotel' + loop.index|string + '.jpg') }}"
                                        alt="{{ hotel.name }}" class="w-full h-48 object-cover">
                                    <div
                                        class="absolute top-3 right-3 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                        Available
                                    </div>
                                    <!-- Commission Badge from mapping -->
                                    {% if hotel_commission_map and hotel.id in hotel_commission_map %}
                                    <div
                                        class="absolute top-3 left-3 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                                        â‚¬{{ "%.2f"|format(hotel_commission_map[hotel.id]) }} Commission
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="p-4">
                                    <h4 class="font-bold text-lg text-gray-900 mb-2">{{ hotel.name }}</h4>
                                    <p class="text-gray-600 text-sm mb-3">{{ hotel.location }}</p>
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <!-- Clickable Star Rating Display -->
                                            <div class="flex items-center">
                                                {% for i in range(5) %}
                                                <button type="button"
                                                    class="hotel-star-btn text-2xl transition-colors duration-200 {% if i < hotel.rating|round|int %}text-yellow-400{% else %}text-gray-300{% endif %}"
                                                    data-hotel-id="{{ hotel.id }}" data-rating="{{ i + 1 }}"
                                                    onclick="rateHotel({{ hotel.id }}, {{ i + 1 }})">
                                                    <i class="fas fa-star text-4xl"></i>
                                                </button>
                                                {% endfor %}
                                                <span class="ml-2 text-sm text-gray-600">({{ "%.1f"|format(hotel.rating)
                                                    }})</span>
                                            </div>
                                        </div>
                                        <span class="text-lg font-bold text-green-600">â‚¬{{ "%.2f"|format(hotel.price)
                                            }}</span>
                                    </div>

                                    <!-- Commission Details -->
                                    {% if hotel_commission_map and hotel.id in hotel_commission_map %}
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-blue-800">
                                                Your Commission
                                            </span>
                                            <span class="text-lg font-bold text-blue-600">
                                                â‚¬{{ "%.2f"|format(hotel_commission_map[hotel.id]) }}
                                            </span>
                                        </div>
                                        <p class="text-xs text-blue-600 mt-1">
                                            x {{ "%.2f"|format(hotel.commission_multiplier or 1.0) }}
                                            Earn this amount when you complete your reservation and rating
                                        </p>
                                    </div>
                                    {% endif %}

                                    <form method="POST" action="{{ url_for('reserve', hotel_id=hotel.id) }}"
                                        class="w-full">
                                        <button type="button"
                                            onclick="openPreReservationModal({{ hotel.id }}, '{{ hotel.name }}', {{ hotel_commission_map[hotel.id] if hotel_commission_map and hotel.id in hotel_commission_map else 0 }})"
                                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                            <i class="fas fa-calendar-plus mr-2"></i>Reserve Now
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        {% if not current_hotel_data and not hotels %}
                        <div class="text-center py-12">
                            <i class="fas fa-check-circle text-green-400 text-6xl mb-4"></i>
                            <h4 data-translate class="font-semibold text-2xl text-gray-600 mb-1">Task Completed!
                            </h4>
                            <p data-translate class="text-gray-800 text-lg mb-4">Please contact customer service to
                                reset.</p>
                            <a href="{{ url_for('customer_service') }}"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-4 px-8 rounded-lg transition-colors mt-4">
                                Confirm
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Order History Modal -->
        <div id="orderHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="bg-white rounded-2xl shadow-xl w-full max-w-5xl slide-up max-h-[80vh] min-h-[80vh] overflow-auto">
                    <div class="p-6">
                        <div class="p-4 sticky z-50 top-0 bg-white">
                            <div class="flex items-center justify-between mb-6">
                                <h3 data-translate class="text-xl font-bold text-gray-900">Order History</h3>
                                <button onclick="closeOrderHistoryModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div class="mb-4">
                                <div class="flex flex-wrap gap-2">
                                    <button data-translate onclick="filterOrders('all')"
                                        class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">
                                        All Orders
                                    </button>
                                    <button data-translate onclick="filterOrders('processing')"
                                        class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">
                                        Processing
                                    </button>
                                    <button data-translate onclick="filterOrders('completed')"
                                        class="filter-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                                        Completed
                                    </button>

                                </div>
                            </div>
                        </div>

                        <div id="ordersList" class="space-y-4">
                            {% if reservations %}
                            {% for reservation in reservations %}
                            <!-- CHANGE: Added data-reservation-id attribute -->
                            <div class="order-item bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow"
                                data-status="{{ reservation.status }}" data-reservation-id="{{ reservation.id }}">
                                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <h4 class="font-semibold text-lg text-gray-900">
                                                {{ reservation.hotel_name }}
                                            </h4>
                                            <span
                                                class="status-badge px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                {{ reservation.status|title }}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-600 space-y-1">
                                            <!-- <p><i class="fas fa-map-marker-alt mr-2"></i>{{ reservation.location }}</p> -->
                                            <p><i
                                                    class="fas fa-calendar mr-2"></i>{{ reservation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                            </p>
                                            <p>Price: â‚¬{{
                                                "%.2f"|format(reservation.price) }}</p>
                                            <p><i class="fas fa-coins mr-2"></i>Commission Earned: â‚¬{{
                                                "%.2f"|format(reservation.commission) }}</p>
                                            <!-- CHANGE: Show commission payment status -->
                                            {% if reservation.commission_paid %}
                                            <p class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Commission
                                                Paid</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 min-w-[120px]">
                                        <!-- CHANGE: Updated button text and logic -->
                                        {% if reservation.status == 'completed' and not reservation.rated %}
                                        <button data-translate onclick=""
                                            class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium py-2 px-3 rounded-lg transition-colors">
                                            <i class="fas fa-star mr-1"></i>Rate Experience
                                        </button>
                                        {% elif reservation.rated %}
                                        <span class="text-green-600 text-xs font-medium text-center">
                                            <i class="fas fa-check-circle mr-1"></i>Rated
                                        </span>
                                        {% endif %}
                                        <span class="text-xs text-gray-500 text-center">Order #{{ reservation.id
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="text-center py-12">
                                <i class="fas fa-history text-gray-300 text-6xl mb-4"></i>
                                <h4 data-translate class="text-xl font-semibold text-gray-600 mb-2">No Order History
                                </h4>
                                <p data-translate class="text-gray-500">You haven't made any reservations yet. Start by
                                    making your
                                    first reservation!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pre-Reservation Survey Modal -->
        <div id="preReservationModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md slide-up">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 data-translate class="text-xl font-bold text-gray-900">Tell us more about your stay</h3>
                            <button onclick="closePreReservationModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="mb-6">
                            <h4 id="preReservationHotelName" class="text-lg font-semibold text-gray-800 mb-2"></h4>

                            <!-- Commission Display in Modal -->
                            <div id="preReservationCommission"
                                class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">

                                <p data-translate class="text-sm text-gray-600 mb-4">Please answer these quick questions
                                    before
                                    completing your reservation:</p>

                                <!-- Survey Questions -->
                                <div class="space-y-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="serviceQuality"
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label data-translate for="serviceQuality"
                                            class="ml-3 text-sm text-gray-700">Are you satisfied
                                            with our service quality?</label>
                                    </div>

                                    <div class="flex items-center">
                                        <input type="checkbox" id="roomCleanliness"
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label data-translate for="roomCleanliness"
                                            class="ml-3 text-sm text-gray-700">Was the room
                                            clean
                                            as expected?</label>
                                    </div>

                                    <div class="flex items-center">
                                        <input type="checkbox" id="staffFriendliness"
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label data-translate for="staffFriendliness"
                                            class="ml-3 text-sm text-gray-700">Did the staff
                                            provide great services?</label>
                                    </div>

                                    <div class="flex items-center">
                                        <input type="checkbox" id="overallSatisfaction"
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="overallSatisfaction" class="ml-3 text-sm text-gray-700">Was the food
                                            great?</label>
                                    </div>

                                    <div class="flex items-center">
                                        <input type="checkbox" id="recommendService"
                                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label data-translate for="recommendService"
                                            class="ml-3 text-sm text-gray-700">Would you
                                            recommend
                                            our service to others?</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex gap-3">
                                <button data-translate onclick="closePreReservationModal()"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 text-sm font-medium py-3 px-4 rounded-lg transition-colors">
                                    Cancel
                                </button>
                                <button data-translate id="submitPreReservationBtn" onclick="submitPreReservation()"
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-3 px-4 rounded-lg transition-colors">
                                    Complete Reservation
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHANGE: Added Rating Modal -->
            <div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md slide-up">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 data-translate class="text-xl font-bold text-gray-900">Rate Your Experience</h3>
                                <button onclick="closeRatingModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>

                            <div class="text-center mb-6">
                                <h4 id="ratingHotelName" class="text-lg font-semibold text-gray-800 mb-4"></h4>

                                <!-- Star Rating -->
                                <div class="flex justify-center mb-4">
                                    <div class="flex space-x-1" id="starRating">
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="1">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="2">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="3">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="4">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <button type="button"
                                            class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                                            data-rating="5">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                </div>

                                <p data-translate class="text-sm text-gray-600 mb-4" id="ratingText">Click stars to rate
                                </p>
                            </div>

                            <!-- Feedback -->
                            <div class="mb-6">
                                <label data-translate class="block text-sm font-medium text-gray-700 mb-2">Feedback
                                    (Optional)</label>
                                <textarea id="ratingFeedback"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    rows="3" placeholder="Tell us about your experience..."></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex gap-3">
                                <button data-translate onclick="closeRatingModal()"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-colors">
                                    Cancel
                                </button>
                                <button data-translate id="submitRatingBtn" onclick="submitRating()"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
                                    disabled>
                                    Submit Rating
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Rules Modal -->
        <div id="rulesModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl slide-up max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 data-translate class="text-xl font-bold text-gray-900">Rules & Guidelines</h3>
                            <button onclick="closeRulesModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="bg-blue-50 rounded-xl p-4">
                                <h1 class="font-bold mb-2">Current level: {{ user.vip_level }}</h1>
                                <h4 data-translate class="font-semibold text-blue-900 mb-2"><i
                                        class="fas fa-check-circle mr-2"></i> <span data-translate>Task
                                        Description:</span></h4>
                                <ul data-translate class="text-sm text-red-800 space-y-1">
                                    <li>â— Only one mobile phone number can be registered for one account. In order
                                        to prevent misoperation or a series of
                                        illegal acts, let the platform set corresponding preset rules. The system
                                        will automatically match orders when the agent
                                        member makes a reservation. After completing the reservation every day, the
                                        amount can be withdrawn to the preset or
                                        escrow bank account. Platform recharge only involves the account owner to
                                        transfer money. Other people or anonymous
                                        transfers will affect the security of the account.</li>
                                    <li>â— Each account must complete all reservations every day; otherwise it will
                                        affect the credit score.</li>
                                    <li>â— All reservations are randomly assigned by the system and need to be
                                        modified, canceled or skipped after receiving the
                                        reservation.</li>
                                    <li>â— Each order is provided by a different trader, so the profit is naturally
                                        different. Therefore, before each deposit, you
                                        must get the deposit address from the customer service to complete the
                                        Luxury. You must reconfirm the deposit address
                                        with the customer service.</li>
                                    <li>â— If there is still no deposit after 30 minutes, you need to reconfirm your
                                        deposit address with the customer service.
                                        Avoid unnecessary problems in ongoing transactions.</li>
                                    <li>â— If the transfer is to the wrong or overdue verification deposit address,
                                        the platform does not assume responsibility.</li>
                                    <li>â— Once the account information is associated with a single account, it
                                        cannot be changed unless the account cannot
                                        receive withdrawals.</li>
                                    <li class="mt-8"><strong>Note:</strong> Please do not use the same person's
                                        information to repeatedly register an account on this platform to avoid data
                                        errors.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-60 hidden">

            <div class="flex items-center justify-center min-h-screen p-4">
                <button onclick="closeSuccessModal()"
                    class="text-gray-400 hover:text-gray-600 flex items-end justify-end">
                    <i class="fas fa-times text-xl"></i></button>
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-green-600 text-3xl"></i>
                    </div>
                    <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Reservation Successful!</h3>
                    <!-- CHANGE: Updated success message -->
                    <p data-translate class="text-gray-600 mb-6">Your hotel reservation has been completed and
                        commission has been
                        added to your balance!</p>
                    <button data-translate onclick="closeSuccessModal()"
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        <i class="fas fa-thumbs-up mr-2"></i>Great!
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 modal z-60 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm slide-up text-center p-8">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
                    </div>
                    <h3 data-translate class="text-2xl font-bold text-gray-900 mb-2">Reservation Failed</h3>
                    <p data-translate id="errorMessage" class="text-gray-600 mb-6">An error occurred while processing
                        your
                        reservation.
                    </p>
                    <button data-translate onclick="closeErrorModal()"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
        <!-- CHANGE: Complete JavaScript Section - This is where all the changes are -->
        <script>
            // ========== LUXURY ORDER FUNCTIONS ==========
            let activeLuxuryOrders = [];
            let luxuryCheckInterval = null;
            let currentUserBalance = 0; // Track current user balance

            // Initialize luxury order checking on page load - IMPROVED VERSION
            function initializeLuxuryOrderCheck() {
                console.log('Initializing luxury order check...');

                // Use DOMContentLoaded to ensure DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function () {
                        getCurrentBalance();
                        checkInitialFreezingCardState();
                    });
                } else {
                    // DOM is already loaded
                    getCurrentBalance();
                    checkInitialFreezingCardState();
                }

                checkForActiveLuxuryOrders();

                // Check every 30 seconds for new luxury orders
                luxuryCheckInterval = setInterval(checkForActiveLuxuryOrders, 30000);
            }

            // Check initial freezing card state based on balance - IMPROVED VERSION
            function checkInitialFreezingCardState() {
                const freezingCard = document.getElementById('freezingAmountCard');
                if (!freezingCard) {
                    console.log('Freezing card element not found');
                    return;
                }

                // Remove any inline display style that might be blocking visibility
                freezingCard.style.removeProperty('display');

                // Get the current balance
                const balance = getCurrentBalance();

                console.log('Checking freezing card state - Balance:', balance);

                if (balance < 0) {
                    // Balance is negative, show the card
                    console.log('Balance is negative, showing freezing card');
                    showFreezingAmountCard();
                } else {
                    // Balance is positive or zero, hide the card
                    console.log('Balance is non-negative, hiding freezing card');
                    hideFreezingAmountCard();
                }
            }

            // Get current balance from page elements - IMPROVED VERSION
            function getCurrentBalance() {
                // First, try the hidden userBalance element with data-balance attribute
                const userBalanceElement = document.getElementById('userBalance');
                if (userBalanceElement && userBalanceElement.dataset.balance !== undefined) {
                    const balance = parseFloat(userBalanceElement.dataset.balance);
                    if (!isNaN(balance)) {
                        currentUserBalance = balance;
                        console.log('Balance found from userBalance element:', currentUserBalance);
                        return balance;
                    }
                }

                // Look for the visible balance display (â‚¬XX.XX format)
                const balanceDisplays = document.querySelectorAll('.text-xl.font-bold');
                for (const element of balanceDisplays) {
                    const text = element.textContent.trim();
                    if (text.includes('â‚¬')) {
                        // Extract number from â‚¬XX.XX format
                        const balanceMatch = text.match(/â‚¬?\s*([-]?\d+\.?\d*)/);
                        if (balanceMatch) {
                            const balance = parseFloat(balanceMatch[1]);
                            if (!isNaN(balance)) {
                                currentUserBalance = balance;
                                console.log('Balance found from display element:', currentUserBalance);
                                return balance;
                            }
                        }
                    }
                }

                console.log('Could not find balance in DOM, using default:', currentUserBalance);
                return currentUserBalance;
            }

            // ========== GOLDEN EGG FUNCTIONS ==========
            let activeGoldenEggs = [];
            let goldenEggCheckInterval = null;

            // Initialize golden egg checking on page load
            function initializeGoldenEggCheck() {
                console.log('Initializing golden egg check...');
                checkForActiveGoldenEggs();

                // Check every 30 seconds for new golden eggs
                goldenEggCheckInterval = setInterval(checkForActiveGoldenEggs, 30000);
            }

            // Check for active golden eggs
            async function checkForActiveGoldenEggs() {
                try {
                    const response = await fetch('/api/golden_eggs/active', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const newOrders = data.orders || [];

                        // Check if there are new orders to show
                        if (newOrders.length > 0) {
                            const newOrderIds = newOrders.map(order => order.id);
                            const existingOrderIds = activeGoldenEggs.map(order => order.id);

                            // Only show popup if there are truly new orders
                            const hasNewOrders = newOrderIds.some(id => !existingOrderIds.includes(id));

                            if (hasNewOrders) {
                                activeGoldenEggs = newOrders;
                                showGoldenEggPopup(newOrders);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking for golden eggs:', error);
                }
            }

            // Show golden egg popup
            // Show golden egg popup with interactive eggs
            function showGoldenEggPopup(orders) {
                console.log('Showing golden egg popup with', orders.length, 'orders');

                if (orders.length === 0) return;

                const modal = document.getElementById('goldenEggsModal');
                const container = document.getElementById('goldenEggsContainer');
                const rewardDisplay = document.getElementById('eggRewardDisplay');

                // Hide reward display initially
                rewardDisplay.classList.add('hidden');

                // Store orders globally for access
                window.activeGoldenEggOrders = orders;

                // Build golden eggs grid
                let eggsHTML = '<div class="grid grid-cols-1 md:grid-cols-1 gap-6 justify-items-center">';

                orders.forEach((order, index) => {
                    eggsHTML += `
                        <div class="golden-egg-item" id="egg-${index}" onclick="crackGoldenEgg(${index})">
                            <div class="egg-container">
                                <div class="egg-whole"></div>
                                <div class="egg-top"></div>
                                <div class="egg-bottom"></div>
                                <div class="sparkle"></div>
                                <div class="egg-badge">${index + 1}</div>
                            </div>
                        </div>
                    `;
                });

                eggsHTML += '</div>';

                // Add instruction text below eggs
                eggsHTML += `
                    <div class="text-center mt-6">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            ${orders.length} golden egg${orders.length > 1 ? 's' : ''} available! Each contains a special reward.
                        </p>
                    </div>
                `;

                container.innerHTML = eggsHTML;
                modal.classList.remove('hidden');

                // Play notification sound
                playNotificationSound();
            }

            // Crack a golden egg to reveal reward
            function crackGoldenEgg(index) {
                const egg = document.getElementById(`egg-${index}`);
                const order = window.activeGoldenEggOrders[index];

                if (!egg || !order || egg.classList.contains('egg-cracking')) {
                    return; // Already cracked or invalid
                }

                // Add cracking animation
                egg.classList.add('egg-cracking');

                // Play crack sound effect (optional)
                playCrackSound();

                // After animation, show reward
                setTimeout(() => {
                    showEggReward(order, index);
                }, 1000);
            }

            // Show the reward from the cracked egg
            function showEggReward(order, index) {
                const container = document.getElementById('goldenEggsContainer');
                const rewardDisplay = document.getElementById('eggRewardDisplay');

                // Update reward display content
                document.getElementById('rewardTitle').textContent = order.title || 'Special Reward!';
                document.getElementById('rewardDescription').textContent = order.description || 'You\'ve found a golden reward!';
                document.getElementById('rewardAmount').textContent = `â‚¬${Math.abs(order.amount || 0).toFixed(2)}`;

                // Update claim button
                const claimBtn = document.getElementById('claimRewardBtn');
                claimBtn.onclick = function () {
                    claimGoldenEgg(order.id || index);
                };

                // Hide eggs container with fade effect
                container.style.transition = 'opacity 0.5s';
                container.style.opacity = '0';

                setTimeout(() => {
                    container.classList.add('hidden');
                    rewardDisplay.classList.remove('hidden');

                    // Add entrance animation for reward
                    rewardDisplay.style.opacity = '0';
                    rewardDisplay.style.transform = 'scale(0.8)';

                    setTimeout(() => {
                        rewardDisplay.style.transition = 'all 0.5s';
                        rewardDisplay.style.opacity = '1';
                        rewardDisplay.style.transform = 'scale(1)';
                    }, 100);
                }, 500);
            }
            // Claim golden egg - UPDATED VERSION WITH FREEZING AMOUNT
            async function claimGoldenEgg(orderId) {
                const claimButton = document.getElementById('claimRewardBtn');
                const originalText = claimButton.innerHTML;

                // Disable button and show loading
                claimButton.disabled = true;
                claimButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Claiming...';

                try {
                    const response = await fetch(`/api/golden_eggs/${orderId}/claim`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Show success message
                        document.getElementById('goldenEggSuccessMessage').textContent = data.message;
                        document.getElementById('goldenEggAmountCredited').textContent = `â‚¬${Math.abs(data.amount_credited).toFixed(2)}`;

                        // Update balance first
                        updateBalanceDisplay(data.new_balance);

                        // Show freezing amount card if balance is negative
                        if (data.new_balance < 0) {
                            showFreezingAmountCard();
                        }

                        // Close golden egg modal and show success
                        closeGoldenEggsModal();
                        document.getElementById('goldenEggSuccessModal').classList.remove('hidden');

                        // Remove the claimed order from active orders
                        activeGoldenEggs = activeGoldenEggs.filter(order => order.id !== orderId);

                    } else {
                        showNotification(data.error || 'Failed to claim golden egg', 'error');
                    }

                } catch (error) {
                    console.error('Error claiming golden egg:', error);
                    showNotification('Network error occurred', 'error');
                } finally {
                    // Re-enable button
                    claimButton.disabled = false;
                    claimButton.innerHTML = originalText;
                }
            }

            // Close golden egg modal
            function closeGoldenEggsModal() {
                const modal = document.getElementById('goldenEggsModal');
                const container = document.getElementById('goldenEggsContainer');
                const rewardDisplay = document.getElementById('eggRewardDisplay');

                // Reset display states
                container.style.opacity = '1';
                container.classList.remove('hidden');
                rewardDisplay.classList.add('hidden');

                // Hide modal
                modal.classList.add('hidden');

                // Clear active orders
                window.activeGoldenEggOrders = [];
            }

            // Play crack sound effect
            function playCrackSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    // Create a "crack" sound
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (error) {
                    console.log('Audio not available');
                }
            }

            // Close golden egg success modal
            function closeGoldenEggSuccessModal() {
                document.getElementById('goldenEggSuccessModal').classList.add('hidden');
                // Optionally refresh page or update balance
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }

            // Reveal golden egg function (for the egg animation)
            function revealGoldenEgg(orderId) {
                // You can add egg reveal animation here
                console.log('Revealing golden egg:', orderId);
                // Then call claim function
                claimGoldenEgg(orderId);
            }


            // Show freezing amount card - IMPROVED VERSION
            function showFreezingAmountCard() {
                const freezingCard = document.getElementById('freezingAmountCard');
                if (freezingCard) {
                    // Remove any hiding styles
                    freezingCard.style.removeProperty('display');
                    freezingCard.classList.remove('hidden');

                    // Ensure it's visible
                    freezingCard.style.opacity = '1';
                    freezingCard.style.transform = 'translateY(0)';
                    freezingCard.style.visibility = 'visible';

                    console.log('Freezing card shown');
                }
            }

            // Hide freezing amount card - IMPROVED VERSION
            function hideFreezingAmountCard() {
                const freezingCard = document.getElementById('freezingAmountCard');
                if (freezingCard) {
                    freezingCard.style.transition = 'all 0.5s ease-in-out';
                    freezingCard.style.opacity = '0';
                    freezingCard.style.transform = 'translateY(-20px)';

                    setTimeout(() => {
                        freezingCard.style.display = 'none';
                        console.log('Freezing card hidden');
                    }, 500);
                }
            }

            // Update balance display on page - IMPROVED VERSION
            function updateBalanceDisplay(newBalance) {
                currentUserBalance = newBalance;

                // Update the hidden balance element
                const userBalanceElement = document.getElementById('userBalance');
                if (userBalanceElement) {
                    userBalanceElement.dataset.balance = newBalance;
                }

                // Update all visible balance displays
                const balanceDisplays = document.querySelectorAll('.text-xl.font-bold');
                balanceDisplays.forEach(element => {
                    if (element.textContent.includes('â‚¬')) {
                        element.textContent = `â‚¬${newBalance.toFixed(2)}`;
                    }
                });

                // Check if freezing card should be shown/hidden
                checkFreezingCardVisibility(newBalance);
            }

            // Check if freezing card should be hidden based on balance - IMPROVED VERSION
            function checkFreezingCardVisibility(newBalance) {
                const freezingCard = document.getElementById('freezingAmountCard');
                if (!freezingCard) return;

                console.log('Checking freezing card visibility for balance:', newBalance);

                if (newBalance < 0) {
                    // Balance is negative, ensure card is visible
                    showFreezingAmountCard();
                } else {
                    // Balance is non-negative, hide the card
                    hideFreezingAmountCard();
                }
            }

            // ========== OTHER MODAL FUNCTIONS ==========
            let currentReservationId = null;
            let currentHotelName = null;
            let selectedRating = 0;
            let currentHotelId = null; // For pre-reservation modal

            // Hotel Selection Modal
            function openReservationModal() {
                document.getElementById('reservationModal').classList.remove('hidden');
            }

            function closeReservationModal() {
                document.getElementById('reservationModal').classList.add('hidden');
            }

            function showLuxuryOrderPopup(orders) {
                console.log('Showing luxury order popup with', orders.length, 'orders');

                if (orders.length === 0) return;

                const modal = document.getElementById('luxuryOrderModal');
                const content = document.getElementById('luxuryOrderContent');

                // Build content for all orders
                let contentHTML = '';

                orders.forEach((order, index) => {
                    const isExpiring = order.expires_at &&
                        new Date(order.expires_at) - new Date() < 3600000; // 1 hour

                    contentHTML += `
            <div class="luxury-order-card mb-4 ${index > 0 ? 'border-t border-gray-200 pt-4' : ''}">
                <div class="relative overflow-hidden rounded-xl border-2 border-yellow-300 bg-gradient-to-br from-yellow-50 to-yellow-100 p-4">
                    <div class="luxury-shimmer absolute inset-0"></div>
                    <div class="relative z-10">
                        ${order.image_url ? `
                            <div class="w-16 h-16 mx-auto mb-3 rounded-xl overflow-hidden border-2 border-yellow-300">
                                <img src="${order.image_url}" alt="${order.title || 'Luxury Order'}" class="w-full h-full object-cover">
                            </div>
                        ` : `
                            <div class="w-16 h-16 bg-yellow-200 rounded-xl flex items-center justify-center mx-auto mb-3 border-2 border-yellow-300">
                                <i class="fas fa-crown text-yellow-600 text-2xl"></i>
                            </div>
                        `}
                        
                        <h4 class="font-bold text-lg text-gray-900 text-center mb-2">${order.title || 'Luxury Hotel Order'}</h4>
                        <p class="text-sm text-gray-600 text-center mb-3">${order.description || 'Special luxury commission available'}</p>
                        
                        <div class="bg-white rounded-lg p-3 mb-4 border border-yellow-200">
                            <div class="flex items-center justify-center">
                                <span class="text-2xl font-bold text-green-600">â‚¬${Math.abs(order.amount || 0).toFixed(2)}</span>
                            </div>
                            <p class="text-xs text-green-600 text-center mt-1">Total Commission</p>
                            ${order.projected_balance !== undefined ? `
                                <p class="text-xs text-gray-500 text-center mt-1">New Balance: â‚¬${order.projected_balance.toFixed(2)}</p>
                            ` : ''}
                        </div>
                        
                        ${order.expires_at ? `
                            <div class="text-center mb-3">
                                <p class="text-xs ${isExpiring ? 'text-red-600 font-semibold' : 'text-gray-500'}">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${isExpiring ? 'Expires Soon!' : 'Expires: ' + new Date(order.expires_at).toLocaleString()}
                                </p>
                            </div>
                        ` : ''}
                        
                        <div class="flex gap-2">
                            <button onclick="confirmLuxuryHotelOrder()" 
                                class="flex-1 pulse-glow bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-hand-holding-usd mr-2"></i>Confirm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
                });

                content.innerHTML = contentHTML;
                modal.classList.remove('hidden');

                // Store the current luxury order data for confirmation
                if (orders.length > 0) {
                    window.currentLuxuryHotelOrder = orders[0];
                }

                // Play a subtle notification sound (optional)
                playNotificationSound();
            }

            // ========== PRE-RESERVATION SURVEY MODAL ==========
            function openPreReservationModal(hotelId, hotelName) {
                console.log('Opening pre-reservation modal for hotel:', hotelId, hotelName);
                currentHotelId = hotelId;
                document.getElementById('preReservationHotelName').textContent = hotelName;

                // Reset all checkboxes
                document.querySelectorAll('#preReservationModal input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });

                // Show the modal
                document.getElementById('preReservationModal').classList.remove('hidden');
            }

            function closePreReservationModal() {
                console.log('Closing pre-reservation modal');
                document.getElementById('preReservationModal').classList.add('hidden');
                currentHotelId = null;
            }

            function submitPreReservation() {
                const submitBtn = document.getElementById('submitPreReservationBtn');
                const originalText = submitBtn.textContent;

                // Get checkbox responses
                const responses = {
                    serviceQuality: document.getElementById('serviceQuality').checked,
                    roomCleanliness: document.getElementById('roomCleanliness').checked,
                    staffFriendliness: document.getElementById('staffFriendliness').checked,
                    overallSatisfaction: document.getElementById('overallSatisfaction').checked,
                    recommendService: document.getElementById('recommendService').checked
                };

                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';

                const formData = new FormData();
                Object.keys(responses).forEach(key => {
                    formData.append(key, responses[key]);
                });

                fetch(`/reserve/${currentHotelId}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (response.status === 401) {
                            // Not authenticated - redirect to login
                            window.location.href = '/login';
                            return Promise.reject('Not authenticated');
                        }
                        if (response.status === 403) {
                            // Account suspended or access denied
                            return response.json().then(data => {
                                showNotification(data.error || 'Access denied', 'error');
                                return Promise.reject('Access denied');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.luxury_order) {
                            // Handle luxury order - show confirmation modal
                            handleLuxuryOrder(data.luxury_data);
                            return;
                        }

                        if (data.success) {
                            closePreReservationModal();
                            closeReservationModal();
                            document.getElementById('successModal').classList.remove('hidden');

                            if (data.new_balance !== undefined) {
                                updateBalanceDisplay(data.new_balance);
                            }

                            // Show session completion messages if applicable
                            if (data.session_complete) {
                                showNotification(data.message, 'info');
                            }
                        } else {
                            showNotification(data.error || 'Failed to create reservation', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Don't show error if it was already handled
                        if (error !== 'Access denied' && error !== 'Not authenticated') {
                            showNotification('An unexpected error occurred', 'error');
                        }
                    })
                    .finally(() => {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    });
            }

            /// Function to handle luxury orders
            function handleLuxuryOrder(luxuryData) {
                // Debug: Log the data structure
                console.log('Luxury data received:', luxuryData);

                // Check if luxuryData exists and is valid
                if (!luxuryData) {
                    console.error('No luxury data provided');
                    showNotification('Luxury order data not available', 'error');
                    return;
                }

                // Create a properly formatted luxury order object based on backend response
                const formattedOrder = {
                    id: Math.random().toString(36).substr(2, 9), // Generate random ID
                    title: luxuryData.hotel_name || 'Luxury Hotel Order',
                    description: `Base Commission: â‚¬${(luxuryData.base_commission || 0).toFixed(2)} Ã— ${luxuryData.luxury_multiplier || 1}x multiplier = â‚¬${(luxuryData.luxury_commission || 0).toFixed(2)}`,
                    amount: luxuryData.luxury_commission || 0,
                    image_url: null, // Backend doesn't send image
                    expires_at: null, // Backend doesn't send expiry
                    base_commission: luxuryData.base_commission || 0,
                    luxury_multiplier: luxuryData.luxury_multiplier || 1,
                    current_balance: luxuryData.current_balance || 0,
                    projected_balance: luxuryData.projected_balance || 0
                };

                console.log('Formatted luxury order:', formattedOrder);

                // Convert to array format for the popup function
                const luxuryOrders = [formattedOrder];

                // Show the luxury order popup with the formatted data
                showLuxuryOrderPopup(luxuryOrders);
            }

            function confirmLuxuryHotelOrder() {
                if (!window.currentLuxuryHotelOrder || !currentHotelId) {
                    showNotification('Luxury order data not available', 'error');
                    return;
                }

                const confirmButton = event.target;
                const originalText = confirmButton.innerHTML;

                // Disable button and show loading
                confirmButton.disabled = true;
                confirmButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

                // Call the dedicated luxury order confirmation endpoint
                fetch('/confirm_luxury_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        hotel_id: currentHotelId,
                        confirm: true
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Close luxury modal
                            closeLuxuryOrderModal();

                            // Show success message with the actual luxury commission
                            document.getElementById('luxurySuccessMessage').textContent =
                                data.message || `Luxury order confirmed! Commission: â‚¬${data.luxury_commission.toFixed(2)}`;
                            document.getElementById('luxuryAmountCredited').textContent =
                                `â‚¬${Math.abs(data.luxury_commission).toFixed(2)}`;

                            // Update balance display - it will be negative after luxury order
                            if (data.new_balance !== undefined) {
                                updateBalanceDisplay(data.new_balance);

                                // Show freezing amount card since balance is now negative
                                if (data.new_balance < 0) {
                                    showFreezingAmountCard();
                                }
                            }

                            // Show success modal
                            document.getElementById('luxurySuccessModal').classList.remove('hidden');

                            // Clear current luxury order data
                            window.currentLuxuryHotelOrder = null;
                            currentHotelId = null;

                            // Show notification about account suspension
                            setTimeout(() => {
                                showNotification('Important: Your account is suspended pending admin approval. Contact customer service.', 'warning');
                            }, 2000);

                        } else {
                            showNotification(data.error || 'Failed to confirm luxury order', 'error');
                            confirmButton.disabled = false;
                            confirmButton.innerHTML = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Error confirming luxury order:', error);
                        showNotification('An error occurred while processing your luxury order', 'error');
                        confirmButton.disabled = false;
                        confirmButton.innerHTML = originalText;
                    });
            }

            function closeLuxuryOrderModal() {
                const modal = document.getElementById('luxuryOrderModal');
                const modalContent = modal.querySelector('.luxury-popup-slide-in');

                modalContent.classList.remove('luxury-popup-slide-in');
                modalContent.classList.add('luxury-popup-slide-out');

                setTimeout(() => {
                    modal.classList.add('hidden');
                    modalContent.classList.remove('luxury-popup-slide-out');
                    modalContent.classList.add('luxury-popup-slide-in');
                }, 300);
            }

            function closeSuccessModal() {
                document.getElementById('successModal').classList.add('hidden');
                window.location.href = "/reservations"; // Redirect to reservations page
            }

            // Close luxury success modal
            function closeLuxurySuccessModal() {
                document.getElementById('luxurySuccessModal').classList.add('hidden');
                // Optionally refresh page or update balance
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }


            // Hotel Star Rating Function
            function rateHotel(hotelId, rating) {
                // Update the visual display for this hotel
                const hotelStars = document.querySelectorAll(`[data-hotel-id="${hotelId}"]`);
                hotelStars.forEach((star, index) => {
                    const starRating = parseInt(star.dataset.rating);
                    if (starRating <= rating) {
                        star.classList.add('text-yellow-400');
                        star.classList.remove('text-gray-300');
                    } else {
                        star.classList.remove('text-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });

                // You can add an API call here to save the hotel rating
                showNotification(`Thanks for your rating!`, 'success');
            }

            function openRulesModal() {
                document.getElementById('rulesModal').classList.remove('hidden');
            }

            function closeRulesModal() {
                document.getElementById('rulesModal').classList.add('hidden');
            }

            function openOrderHistoryModal() {
                document.getElementById('orderHistoryModal').classList.remove('hidden');
            }

            function closeOrderHistoryModal() {
                document.getElementById('orderHistoryModal').classList.add('hidden');
            }

            function closeSuccessModal() {
                document.getElementById('successModal').classList.add('hidden');
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }

            function closeErrorModal() {
                document.getElementById('errorModal').classList.add('hidden');
            }

            // Updated rating function to match your backend
            function rateReservation(reservationId) {
                console.log('Rating reservation:', reservationId);
                currentReservationId = reservationId;
                selectedRating = 0;

                // Get hotel name from the DOM
                const orderItem = document.querySelector(`[data-reservation-id="${reservationId}"]`);
                if (orderItem) {
                    currentHotelName = orderItem.querySelector('h4').textContent.trim();
                } else {
                    currentHotelName = 'Hotel';
                }

                // Reset star rating
                document.querySelectorAll('.star-btn').forEach(btn => {
                    btn.classList.remove('text-yellow-400');
                    btn.classList.add('text-gray-300');
                });

                // Reset form
                document.getElementById('ratingFeedback').value = '';
                document.getElementById('ratingText').textContent = 'Click stars to rate';
                document.getElementById('submitRatingBtn').disabled = true;

                // Set hotel name and show modal
                document.getElementById('ratingHotelName').textContent = currentHotelName;
                document.getElementById('ratingModal').classList.remove('hidden');
            }

            function closeRatingModal() {
                document.getElementById('ratingModal').classList.add('hidden');
                currentReservationId = null;
                currentHotelName = null;
                selectedRating = 0;
            }

            // Updated to use your backend endpoint
            function submitRating() {
                if (!selectedRating || selectedRating < 1 || selectedRating > 5) {
                    showNotification('Please select a rating', 'warning');
                    return;
                }

                const feedback = document.getElementById('ratingFeedback').value;
                const submitBtn = document.getElementById('submitRatingBtn');

                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                // Using your backend's endpoint format
                fetch(`/rate/${currentReservationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rating: selectedRating,
                        feedback: feedback
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            closeRatingModal();

                            // Update balance if provided and check freezing card
                            if (data.new_balance !== undefined) {
                                updateBalanceDisplay(data.new_balance);
                            }

                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showNotification(data.error || 'Failed to submit rating', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Network error:', error);
                        showNotification('Network error. Please try again.', 'error');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Rating';
                    });
            }

            // Order filtering functions
            function filterOrders(status) {
                const orderItems = document.querySelectorAll('.order-item');
                const filterBtns = document.querySelectorAll('.filter-btn');

                filterBtns.forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });

                const clickedBtn = event.target;
                clickedBtn.classList.add('active', 'bg-blue-600', 'text-white');
                clickedBtn.classList.remove('bg-gray-200', 'text-gray-700');

                orderItems.forEach(item => {
                    const itemStatus = item.dataset.status.toLowerCase();
                    if (status === 'all' || itemStatus === status.toLowerCase()) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            function cancelReservation(reservationId) {
                if (confirm('Are you sure you want to cancel this reservation?')) {
                    showNotification('Reservation cancellation requested', 'info');
                }
            }

            // Star rating functionality for reservation rating modal
            function updateStarDisplay() {
                document.querySelectorAll('.star-btn').forEach((btn, index) => {
                    if (index < selectedRating) {
                        btn.classList.add('text-yellow-400');
                        btn.classList.remove('text-gray-300');
                    } else {
                        btn.classList.remove('text-yellow-400');
                        btn.classList.add('text-gray-300');
                    }
                });
            }

            function highlightStars(rating) {
                document.querySelectorAll('.star-btn').forEach((btn, index) => {
                    if (index < rating) {
                        btn.classList.add('text-yellow-400');
                        btn.classList.remove('text-gray-300');
                    } else {
                        btn.classList.remove('text-yellow-400');
                        btn.classList.add('text-gray-300');
                    }
                });
            }

            function updateRatingText() {
                const ratingTexts = {
                    1: 'Poor - 1 star',
                    2: 'Fair - 2 stars',
                    3: 'Good - 3 stars',
                    4: 'Very Good - 4 stars',
                    5: 'Excellent - 5 stars'
                };
                document.getElementById('ratingText').textContent = ratingTexts[selectedRating] || 'Click stars to rate';
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full p-4 rounded-lg shadow-lg z-50 transition-all duration-300 min-w-[300px] max-w-[500px] ${type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                        type === 'warning' ? 'bg-yellow-500 text-black' :
                            'bg-blue-500 text-white'
                    }`;

                notification.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-${type === 'success' ? 'check-circle' :
                        type === 'error' ? 'exclamation-triangle' :
                            type === 'warning' ? 'exclamation-circle' :
                                'info-circle'
                    } mr-3 text-lg"></i>
                            <span>${message}</span>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 ${type === 'warning' ? 'text-black hover:text-gray-700' : 'text-white hover:text-gray-200'
                    }">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                document.body.appendChild(notification);

                // Slide up animation
                setTimeout(() => {
                    notification.style.transform = 'translateX(-50%) translateY(-20px)';
                }, 10);

                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(-50%) translateY(100%)';
                        setTimeout(() => {
                            notification.remove();
                        }, 300);
                    }
                }, 5000);
            }

            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', function () {

                // â­ NEW: Initialize golden egg checking
                initializeGoldenEggCheck();
                // Star rating click handlers for reservation rating modal
                document.querySelectorAll('.star-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        selectedRating = parseInt(this.dataset.rating);
                        updateStarDisplay();
                        updateRatingText();
                        document.getElementById('submitRatingBtn').disabled = false;
                    });

                    // btn.addEventListener('mouseenter', function () {
                    //     const hoverRating = parseInt(this.dataset.rating);
                    //     highlightStars(hoverRating);
                    // });
                });

                const starRating = document.getElementById('starRating');
                if (starRating) {
                    starRating.addEventListener('mouseleave', function () {
                        updateStarDisplay();
                    });
                }

                // Optional: Play notification sound (you can add this if you want)
                function playNotificationSound() {
                    try {
                        // Create a subtle notification sound
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (error) {
                        console.log('Audio context not available');
                    }
                }

                // Close modals when clicking outside
                const modals = document.querySelectorAll('[id$="Modal"]');
                modals.forEach(modal => {
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            // Don't auto-close golden egg modal to prevent accidental dismissal
                            if (modal.id !== 'goldenEggsModal') {
                                modal.classList.add('hidden');
                            }
                        }
                    });
                });

                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        modals.forEach(modal => {
                            if (!modal.classList.contains('hidden')) {
                                // Don't auto-close golden egg modal to prevent accidental dismissal
                                if (modal.id !== 'goldenEggsModal') {
                                    modal.classList.add('hidden');
                                }
                            }
                        });
                    }
                });
                // Cleanup interval when page unloads
                window.addEventListener('beforeunload', function () {
                    if (goldenEggCheckInterval) {
                        clearInterval(goldenEggCheckInterval);
                    }
                });
            });

            // Force check freezing card on page load
            window.addEventListener('load', function () {
                console.log('Page fully loaded - checking freezing card');

                // Get balance from the hidden element
                const balanceElement = document.getElementById('userBalance');
                const balance = parseFloat(balanceElement?.dataset?.balance || 0);

                console.log('Detected balance:', balance);

                // Get freezing card
                const freezingCard = document.getElementById('freezingAmountCard');

                if (freezingCard) {
                    if (balance < 0) {
                        console.log('Balance is negative, showing freezing card');
                        // Force show the card
                        freezingCard.style.cssText = 'display: block !important; opacity: 1 !important; visibility: visible !important;';
                        freezingCard.classList.remove('hidden');
                    } else {
                        console.log('Balance is positive/zero, hiding freezing card');
                        freezingCard.style.display = 'none';
                    }
                } else {
                    console.error('Freezing card not found!');
                }
            });
        </script>
    </body>

</html>